<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>StackModelShapExplainer Documentation – Making sharable documents</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../statistic/Index.html" rel="next">
<link href="../machine-learning/deep_dive_stacking_model_multi_class.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-73b965cdad09bb77b1eccbeb273f96b8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-99b1fd8f755da725bc21a93c890ebd16.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-73b965cdad09bb77b1eccbeb273f96b8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../machine-learning/Index.html">Machine learning</a></li><li class="breadcrumb-item"><a href="../machine-learning/StackModelShapExplainer.html">StackModelShapExplainer Documentation</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/b_hex.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://nguyenngocbinh.github.io/papers" title="nguyenngocbinh.github.io/papers" class="quarto-navigation-tool px-1" aria-label="nguyenngocbinh.github.io/papers"><i class="bi bi-globe"></i></a>
    <a href="https://github.com/nguyenngocbinh/papers" title="github" class="quarto-navigation-tool px-1" aria-label="github"><i class="bi bi-github"></i></a>
    <a href="https://twitter.com/nanabi88" title="nanabi88 Twitter" class="quarto-navigation-tool px-1" aria-label="nanabi88 Twitter"><i class="bi bi-twitter"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../irb/ModelGuideline.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model guideline</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../irb/ModelGuideline.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model guideline</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../machine-learning/Index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Machine learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/focal-loss.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Focal loss - handle class imbalance</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/delong_test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Delong method for AUC interval and AUC test</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/FeatureImportance_Permutation_versus_MeanDecrease.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overestimate feature importance in Random Forest</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/SHAP_SHapley_Additive_exPlanations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SHAP values and Coefficients of Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/cal_shap_use_lightgbm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tính toán giá trị SHAP sử dụng thư viện LightGBM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/CohortFitDistribution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fit Distribution</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/modelCalibration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model calibration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/transformer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transformer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/ReinforcementLearningConcept.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reinforcement Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/EnhanceTraditionalScoreCardByReinforcementLearning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Use Reinforcement learning to enhance traditional scorecard</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/IsolationForest.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Isolation Forest - anomaly detection</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/Autoencoders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Autoencoders - anomaly detection</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/Classifier_Chain.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Classifier Chain</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/Wine_Quality_pytorch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Train a model on the Wine Quality dataset using ordinal loss and the Kappa metric in PyTorch</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/Partial_dependence_and_Accumulated_local_Profiles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Partial-dependence Profiles vs Accumulated-local Profiles</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/LightGBM_Predict_Contrib_for_Multi_Class.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LightGBM Predict Contrib for Multi-Class Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/deep_dive_stacking_model_multi_class.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deep Dive into Stacking Model for Multi-Class Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../machine-learning/StackModelShapExplainer.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">StackModelShapExplainer Documentation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../statistic/Index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistic</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../statistic/StandardizedCoefficients.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Standardized Coefficients vs Unstandardized Coefficients</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../statistic/confidenceIntervalWithSmallSampleSize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ước lượng khoảng tin cậy với cỡ mẫu nhỏ</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../statistic/PSI_KS_ENTROPY.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Giám sát độ ổn định của mô hình</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../statistic/DiD.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Difference-in-Differences (DiD)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../statistic/MonteCarlo_Bootstrap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">So sánh giữa Monte Carlo Simulation và Bootstrap</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../statistic/Binomial_interval.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">So sánh Likelihood Ratio, Jeffreys và Clopper-Pearson trong ước lượng khoảng tin cậy cho phân phối binomial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../statistic/ordinal_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mô Hình Hồi Quy Logistic Thứ Tự</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../statistic/Closeness_Evaluation_Measure_CEM.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Closeness Evaluation Measure (CEM)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../statistic/Wine_Quality_Monotonic_Binning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Monotonic Trend with Wine Quality Dataset</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../statistic/Mixture_distribution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mixture distribution</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../explore.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Explore and setup</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../quarto-workflows/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quarto workflows</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quarto-workflows/browser.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">From the Browser</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quarto-workflows/rstudio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">From RStudio</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../quarto-workflows/jupyter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">From Jupyter</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../learning-more.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Learning more</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../transition-from-rmarkdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transition from Rmd</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">Methodology</a>
  <ul class="collapse">
  <li><a href="#multi-level-shap-approach" id="toc-multi-level-shap-approach" class="nav-link" data-scroll-target="#multi-level-shap-approach">1. Multi-level SHAP Approach</a></li>
  <li><a href="#influence-chain-calculation" id="toc-influence-chain-calculation" class="nav-link" data-scroll-target="#influence-chain-calculation">2. Influence Chain Calculation</a></li>
  <li><a href="#background-data-sampling" id="toc-background-data-sampling" class="nav-link" data-scroll-target="#background-data-sampling">3. Background Data Sampling</a></li>
  </ul></li>
  <li><a href="#user-manual" id="toc-user-manual" class="nav-link" data-scroll-target="#user-manual">User Manual</a>
  <ul class="collapse">
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#initializing-the-explainer" id="toc-initializing-the-explainer" class="nav-link" data-scroll-target="#initializing-the-explainer">Initializing the Explainer</a></li>
  <li><a href="#basic-usage" id="toc-basic-usage" class="nav-link" data-scroll-target="#basic-usage">Basic Usage</a></li>
  <li><a href="#exploring-feature-influence" id="toc-exploring-feature-influence" class="nav-link" data-scroll-target="#exploring-feature-influence">Exploring Feature Influence</a></li>
  <li><a href="#exploring-model-influence" id="toc-exploring-model-influence" class="nav-link" data-scroll-target="#exploring-model-influence">Exploring Model Influence</a></li>
  <li><a href="#visualizing-overall-feature-importance" id="toc-visualizing-overall-feature-importance" class="nav-link" data-scroll-target="#visualizing-overall-feature-importance">Visualizing Overall Feature Importance</a></li>
  <li><a href="#visualizing-the-prediction-path" id="toc-visualizing-the-prediction-path" class="nav-link" data-scroll-target="#visualizing-the-prediction-path">Visualizing the Prediction Path</a></li>
  </ul></li>
  <li><a href="#function-reference" id="toc-function-reference" class="nav-link" data-scroll-target="#function-reference">Function Reference</a>
  <ul class="collapse">
  <li><a href="#core-functions" id="toc-core-functions" class="nav-link" data-scroll-target="#core-functions">Core Functions</a></li>
  <li><a href="#visualization-functions" id="toc-visualization-functions" class="nav-link" data-scroll-target="#visualization-functions">Visualization Functions</a></li>
  </ul></li>
  <li><a href="#explanation-structure" id="toc-explanation-structure" class="nav-link" data-scroll-target="#explanation-structure">Explanation Structure</a></li>
  <li><a href="#example-workflow" id="toc-example-workflow" class="nav-link" data-scroll-target="#example-workflow">Example Workflow</a></li>
  <li><a href="#best-practices" id="toc-best-practices" class="nav-link" data-scroll-target="#best-practices">Best Practices</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a>
  <ul class="collapse">
  <li><a href="#verify_chain_rule_calculation-function" id="toc-verify_chain_rule_calculation-function" class="nav-link" data-scroll-target="#verify_chain_rule_calculation-function"><code>verify_chain_rule_calculation</code> Function</a></li>
  <li><a href="#print_detailed_shap_values-function" id="toc-print_detailed_shap_values-function" class="nav-link" data-scroll-target="#print_detailed_shap_values-function"><code>print_detailed_shap_values</code> Function</a></li>
  </ul></li>
  <li><a href="#a-new-observation" id="toc-a-new-observation" class="nav-link" data-scroll-target="#a-new-observation">A new observation</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.dev/nguyenngocbinh/papers/blob/main/machine-learning/StackModelShapExplainer.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/nguyenngocbinh/papers/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../machine-learning/Index.html">Machine learning</a></li><li class="breadcrumb-item"><a href="../machine-learning/StackModelShapExplainer.html">StackModelShapExplainer Documentation</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">StackModelShapExplainer Documentation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p><code>StackModelShapExplainer</code> is a specialized explainability tool designed for stacked ensemble models, providing deep insights into how predictions flow through complex multi-model architectures. It extends traditional SHAP (SHapley Additive exPlanations) analysis to work with hierarchical models where base models feed into meta-models.</p>
</section>
<section id="methodology" class="level2">
<h2 class="anchored" data-anchor-id="methodology">Methodology</h2>
<section id="multi-level-shap-approach" class="level3">
<h3 class="anchored" data-anchor-id="multi-level-shap-approach">1. Multi-level SHAP Approach</h3>
<p>The <code>StackModelShapExplainer</code> uses a hierarchical approach to calculate feature attributions:</p>
<ol type="1">
<li><p><strong>Base Model Explanations</strong>: SHAP values are calculated for each base model independently, showing how input features influence each base model’s predictions.</p></li>
<li><p><strong>Meta-Model Explanations</strong>: SHAP values are calculated for the meta-model, showing how the outputs from base models (meta-features) influence the final prediction.</p></li>
<li><p><strong>Combined Explanations</strong>: The two levels of SHAP values are combined using chain rule principles to trace the influence of original features through the entire model stack to the final prediction.</p></li>
</ol>
</section>
<section id="influence-chain-calculation" class="level3">
<h3 class="anchored" data-anchor-id="influence-chain-calculation">2. Influence Chain Calculation</h3>
<p>For each feature in the input data, the explainer calculates an “influence chain” showing how that feature affects the final prediction:</p>
<pre><code>Original feature → Base model outputs → Meta-model → Final prediction</code></pre>
<p>The full attribution calculation follows this formula:</p>
<p>For a feature x_i, its total influence on the final prediction is:</p>
<p><span class="math display">\[\phi_{\text{combined}}(x_i) = \sum_{j} \phi_{\text{meta}}(f_j) \cdot \frac{\partial f_j}{\partial x_i}\]</span></p>
<p>Where: - <span class="math inline">\(\phi_{\text{combined}}(x_i)\)</span> is the combined SHAP value for feature <span class="math inline">\(x_i\)</span> - <span class="math inline">\(\phi_{\text{meta}}(f_j)\)</span> is the meta-model SHAP value for meta-feature <span class="math inline">\(f_j\)</span> - <span class="math inline">\(\frac{\partial f_j}{\partial x_i}\)</span> represents how meta-feature <span class="math inline">\(f_j\)</span> changes with feature <span class="math inline">\(x_i\)</span></p>
</section>
<section id="background-data-sampling" class="level3">
<h3 class="anchored" data-anchor-id="background-data-sampling">3. Background Data Sampling</h3>
<p>To calculate SHAP values efficiently, the explainer uses a sampling approach:</p>
<ul>
<li>A subset of the training data is used as background data</li>
<li>This provides a reference distribution for feature values</li>
<li>The sampling is stratified to maintain class balance (for classification problems)</li>
</ul>
</section>
</section>
<section id="user-manual" class="level2">
<h2 class="anchored" data-anchor-id="user-manual">User Manual</h2>
<section id="installation" class="level3">
<h3 class="anchored" data-anchor-id="installation">Installation</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming you have the StackModelShapExplainer class defined</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># No additional packages beyond standard ML libraries and SHAP are required</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="initializing-the-explainer" class="level3">
<h3 class="anchored" data-anchor-id="initializing-the-explainer">Initializing the Explainer</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an explainer for your stacked model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>explainer <span class="op">=</span> StackModelShapExplainer(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    stack_model<span class="op">=</span>stack_model,  <span class="co"># Your trained stacking model</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    background_data<span class="op">=</span>X_train,  <span class="co"># Training data for background distribution</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    n_background<span class="op">=</span><span class="dv">100</span>          <span class="co"># Number of background samples to use</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="basic-usage" class="level3">
<h3 class="anchored" data-anchor-id="basic-usage">Basic Usage</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get explanation for a single observation</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>explanation <span class="op">=</span> explainer.explain_instance(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    X_instance<span class="op">=</span>new_observation,  <span class="co"># DataFrame with a single row</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    target_class<span class="op">=</span><span class="dv">1</span>               <span class="co"># For classification, which class to explain</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a waterfall plot showing feature contributions</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> explainer.plot_waterfall(</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    X_instance<span class="op">=</span>new_observation,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    target_class<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    max_features<span class="op">=</span><span class="dv">10</span>  <span class="co"># Show only top 10 features</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exploring-feature-influence" class="level3">
<h3 class="anchored" data-anchor-id="exploring-feature-influence">Exploring Feature Influence</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get detailed influence information for a specific feature</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>influence <span class="op">=</span> explainer.get_feature_influence(explanation, <span class="st">'feature_name'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total influence: </span><span class="sc">{</span>influence[<span class="st">'combined_influence'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Influence paths:"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> meta_feature, value <span class="kw">in</span> influence[<span class="st">'influence_paths'</span>].items():</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Via </span><span class="sc">{</span>meta_feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">:.6f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exploring-model-influence" class="level3">
<h3 class="anchored" data-anchor-id="exploring-model-influence">Exploring Model Influence</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get detailed influence information for a specific base model</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>model_influence <span class="op">=</span> explainer.get_model_influence(explanation, <span class="st">'model_name'</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total model influence: </span><span class="sc">{</span>model_influence[<span class="st">'total_influence'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Influence through meta-features:"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> meta_feature, value <span class="kw">in</span> model_influence[<span class="st">'meta_features'</span>].items():</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Via </span><span class="sc">{</span>meta_feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="visualizing-overall-feature-importance" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-overall-feature-importance">Visualizing Overall Feature Importance</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot overall feature importance</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> explainer.plot_feature_importance(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    X_data<span class="op">=</span>X_test,         <span class="co"># Data to calculate importance over</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    target_class<span class="op">=</span><span class="dv">1</span>,        <span class="co"># Class to explain (for classification)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    max_features<span class="op">=</span><span class="dv">15</span>,       <span class="co"># Number of features to show</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    plot_type<span class="op">=</span><span class="st">'bar'</span>        <span class="co"># 'bar' or 'violin'</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="visualizing-the-prediction-path" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-the-prediction-path">Visualizing the Prediction Path</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize how a prediction flows through the model</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>viz <span class="op">=</span> explainer.visualize_prediction_path(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    X_instance<span class="op">=</span>new_observation,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    target_class<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    top_features<span class="op">=</span><span class="dv">5</span>         <span class="co"># Number of top features to highlight</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="function-reference" class="level2">
<h2 class="anchored" data-anchor-id="function-reference">Function Reference</h2>
<section id="core-functions" class="level3">
<h3 class="anchored" data-anchor-id="core-functions">Core Functions</h3>
<section id="explain_instancex_instance-target_classnone" class="level4">
<h4 class="anchored" data-anchor-id="explain_instancex_instance-target_classnone"><code>explain_instance(X_instance, target_class=None)</code></h4>
<p>Generates a comprehensive explanation for a single observation, returning a dictionary with SHAP values at each level of the model.</p>
</section>
<section id="plot_waterfallx_instance-target_classnone-max_features10" class="level4">
<h4 class="anchored" data-anchor-id="plot_waterfallx_instance-target_classnone-max_features10"><code>plot_waterfall(X_instance, target_class=None, max_features=10)</code></h4>
<p>Creates a waterfall plot showing how each feature contributes to pushing the prediction away from the baseline value.</p>
</section>
<section id="get_feature_influenceexplanation-feature_name" class="level4">
<h4 class="anchored" data-anchor-id="get_feature_influenceexplanation-feature_name"><code>get_feature_influence(explanation, feature_name)</code></h4>
<p>Extracts detailed information about how a specific feature influences the final prediction through various paths in the model.</p>
</section>
<section id="get_model_influenceexplanation-model_name" class="level4">
<h4 class="anchored" data-anchor-id="get_model_influenceexplanation-model_name"><code>get_model_influence(explanation, model_name)</code></h4>
<p>Analyzes how a specific base model influences the final prediction through its output meta-features.</p>
</section>
</section>
<section id="visualization-functions" class="level3">
<h3 class="anchored" data-anchor-id="visualization-functions">Visualization Functions</h3>
<section id="plot_feature_importancex_data-target_classnone-max_features15-plot_typebar" class="level4">
<h4 class="anchored" data-anchor-id="plot_feature_importancex_data-target_classnone-max_features15-plot_typebar"><code>plot_feature_importance(X_data, target_class=None, max_features=15, plot_type='bar')</code></h4>
<p>Creates a bar or violin plot showing the overall importance of features across multiple observations.</p>
</section>
<section id="visualize_prediction_pathx_instance-target_classnone-top_features5" class="level4">
<h4 class="anchored" data-anchor-id="visualize_prediction_pathx_instance-target_classnone-top_features5"><code>visualize_prediction_path(X_instance, target_class=None, top_features=5)</code></h4>
<p>Generates a visualization showing how feature values flow through the model to influence the final prediction.</p>
</section>
</section>
</section>
<section id="explanation-structure" class="level2">
<h2 class="anchored" data-anchor-id="explanation-structure">Explanation Structure</h2>
<p>The <code>explain_instance()</code> function returns a dictionary with the following components:</p>
<pre><code>{
    'combined_shap': {
        'feature1': 0.23,  # Combined influence of feature1 on final prediction
        'feature2': -0.11, # etc.
        ...
    },
    'feature_influence_chain': {
        'feature1': {
            'meta_feature1': 0.15,  # How feature1 influences through meta_feature1
            'meta_feature2': 0.08,  # How feature1 influences through meta_feature2
            ...
        },
        ...
    },
    'meta_model_shap': array(...),  # SHAP values for meta-model
    'base_model_shap': {
        'model1': {
            'shap_values': array(...),  # SHAP values for base model
            'feature_names': [...]      # Features used by this model
        },
        ...
    },
    'meta_model_expected_value': 0.5,  # Baseline prediction of meta-model
    'prediction': 0.73  # Final prediction value
}</code></pre>
</section>
<section id="example-workflow" class="level2">
<h2 class="anchored" data-anchor-id="example-workflow">Example Workflow</h2>
<ol type="1">
<li><strong>Train a stacked ensemble model</strong> using your preferred library</li>
<li><strong>Initialize the explainer</strong> with your trained model and background data</li>
<li><strong>Generate explanations</strong> for observations of interest</li>
<li><strong>Visualize the results</strong> using the provided plotting functions</li>
<li><strong>Drill down</strong> into specific features or models using the get_feature_influence and get_model_influence functions</li>
</ol>
</section>
<section id="best-practices" class="level2">
<h2 class="anchored" data-anchor-id="best-practices">Best Practices</h2>
<ol type="1">
<li><strong>Use a representative background dataset</strong> - The quality of SHAP explanations depends on having a good baseline distribution</li>
<li><strong>Consider computational resources</strong> - SHAP analysis can be computationally intensive, so adjust n_background accordingly</li>
<li><strong>Focus on important features</strong> - Use max_features parameters to focus on the most influential variables</li>
<li><strong>Compare across instances</strong> - Look at explanations for multiple observations to understand model behavior</li>
<li><strong>Combine with other techniques</strong> - Use in conjunction with partial dependence plots and other explanatory techniques</li>
</ol>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<ol type="1">
<li><strong>Approximation</strong> - The explainer uses approximations for efficiency, which may slightly reduce accuracy</li>
<li><strong>Computational Cost</strong> - Full SHAP analysis can be slow for very large models or datasets</li>
<li><strong>Linear Combination Assumption</strong> - The influence chain calculation assumes effects combine linearly</li>
<li><strong>Feature Independence</strong> - Standard SHAP assumes feature independence, which may not hold in all datasets</li>
</ol>
<div id="ae33edad" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_predict</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StackModel:</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_configs, final_estimator, cv<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Initialize the stacking model.</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">            model_configs (dict): Configuration for base models. Each key is a model name, and </span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">                the value is a dictionary with the following keys:</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">                - 'feature_names': List of feature names used by the model.</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">                - 'estimators': The model class (e.g., sklearn classifier or regressor).</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">                - 'hyperparameters': Dictionary of hyperparameters for the estimator.</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">            final_estimator (BaseEstimator): Meta-model for stacking.</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co">            cv (int, cross-validation generator, or None): Cross-validation strategy for </span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co">                generating meta-features. Default is None (5-fold CV).</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_configs <span class="op">=</span> model_configs</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.final_estimator <span class="op">=</span> final_estimator</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cv <span class="op">=</span> cv <span class="kw">or</span> <span class="dv">5</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.models <span class="op">=</span> {}</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.classes_ <span class="op">=</span> <span class="va">None</span>  </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.feature_names_ <span class="op">=</span> <span class="va">None</span>  </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y):</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Train the stacking model.</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="co">            X (pd.DataFrame): Feature matrix.</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="co">            y (pd.Series or np.ndarray): Target vector.</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(X, pd.DataFrame):</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"X must be a pandas DataFrame."</span>)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(y, (pd.Series, np.ndarray)):</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"y must be a pandas Series or a numpy array."</span>)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store class labels</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>.final_estimator, <span class="st">"classes_"</span>) <span class="kw">or</span> <span class="bu">hasattr</span>(<span class="va">self</span>.final_estimator, <span class="st">"predict_proba"</span>):</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.classes_ <span class="op">=</span> np.unique(y)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.models <span class="op">=</span> {}</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        meta_features_list <span class="op">=</span> []</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        meta_feature_names <span class="op">=</span> []</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train base models and generate cross-validated meta-features</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model_name, config <span class="kw">in</span> <span class="va">self</span>.model_configs.items():</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>            features <span class="op">=</span> config[<span class="st">'feature_names'</span>]</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> config[<span class="st">'estimators'</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>                estimator <span class="op">=</span> config[<span class="st">'estimators'</span>](<span class="op">**</span>config[<span class="st">'hyperparameters'</span>])</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Generate cross-validated meta-features</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>                meta_features <span class="op">=</span> cross_val_predict(</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>                    estimator, X[features], y, cv<span class="op">=</span><span class="va">self</span>.cv, method<span class="op">=</span><span class="st">'predict_proba'</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>                meta_features_list.append(meta_features)</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>                meta_feature_names.extend(</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>                    [<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_class</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(meta_features.shape[<span class="dv">1</span>])]</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Train the model on the full dataset</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>                estimator.fit(X[features], y)</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.models[model_name] <span class="op">=</span> {</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'features'</span>: features,</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'model'</span>: estimator</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Use raw features directly for models without estimators</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>                meta_features <span class="op">=</span> X[features].values</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>                meta_features_list.append(meta_features)</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>                meta_feature_names.extend(features)</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.models[model_name] <span class="op">=</span> {</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'features'</span>: features,</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'model'</span>: <span class="va">None</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine all meta-features</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.meta_features <span class="op">=</span> np.hstack(meta_features_list)</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store meta-feature names</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.feature_name_ <span class="op">=</span> meta_feature_names</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train the final estimator using meta-features</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.final_estimator.fit(<span class="va">self</span>.meta_features, y)</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, X, raw_score<span class="op">=</span><span class="va">False</span>, pred_contrib<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a><span class="co">        Predict class labels using the stacking model.</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a><span class="co">            X (pd.DataFrame): Feature matrix.</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a><span class="co">            raw_score (bool): Whether to return raw scores (decision function output).</span></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a><span class="co">            np.ndarray: Predicted class labels or decision function output.</span></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>        meta_features <span class="op">=</span> <span class="va">self</span>.transform(X)</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Support raw_score only if the final estimator is LightGBM</span></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> raw_score:</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(<span class="va">self</span>.final_estimator, lgb.LGBMClassifier):</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">self</span>.final_estimator.predict(X<span class="op">=</span>meta_features, raw_score<span class="op">=</span><span class="va">True</span>)  <span class="co"># Return raw score for LGBM</span></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">TypeError</span>(<span class="st">"The 'raw_score' option is only supported for LGBMClassifier."</span>)</span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Support pred_contrib only if the final estimator is LightGBM</span></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pred_contrib:</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(<span class="va">self</span>.final_estimator, lgb.LGBMClassifier):</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Return SHAP-like feature contributions (pred_contrib) for LGBMClassifier</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">self</span>.final_estimator.predict(X<span class="op">=</span>meta_features, pred_contrib<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">TypeError</span>(<span class="st">"The 'pred_contrib' option is only supported for LGBMClassifier."</span>)</span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.final_estimator.predict(meta_features)</span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict_proba(<span class="va">self</span>, X):</span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a><span class="co">        Predict probabilities using the stacking model.</span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a><span class="co">            X (pd.DataFrame): Feature matrix.</span></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a><span class="co">            np.ndarray: Predicted probabilities.</span></span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>        meta_features <span class="op">=</span> <span class="va">self</span>.transform(X)</span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.final_estimator.predict_proba(meta_features)</span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a><span class="co">        Generate meta-features for a given dataset, transforming the input features.</span></span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a><span class="co">            X (pd.DataFrame): Feature matrix.</span></span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a><span class="co">            np.ndarray: Transformed meta-features as a numpy array.</span></span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(X, pd.DataFrame):</span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"X must be a pandas DataFrame."</span>)</span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>        meta_features <span class="op">=</span> []</span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model_name, model_info <span class="kw">in</span> <span class="va">self</span>.models.items():</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>            features <span class="op">=</span> model_info[<span class="st">'features'</span>]</span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> model_info[<span class="st">'model'</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> model_info[<span class="st">'model'</span>]</span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>                meta_features.append(model.predict_proba(X[features]))</span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>                meta_features.append(X[features].values)</span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.hstack(meta_features)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="03b88953" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_predict</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shap</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StackModelShapExplainer:</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Class to explain predictions from a StackModel using SHAP values.</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">    This separate class handles the explanation of predictions without modifying the original model.</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, stack_model, background_data<span class="op">=</span><span class="va">None</span>, n_background<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Initialize the SHAP explainer for a StackModel.</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co">            stack_model (StackModel): The trained stacking model to explain</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co">            background_data (pd.DataFrame, optional): Background data for SHAP explainers</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co">            n_background (int): Number of background samples to use if background_data is large</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stack_model <span class="op">=</span> stack_model</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create background data for SHAP explainers</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> background_data <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Background data must be provided for SHAP explainers"</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(background_data) <span class="op">&gt;</span> n_background:</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.background_data <span class="op">=</span> background_data.sample(n_background, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.background_data <span class="op">=</span> background_data</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize explainers for each model</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.explainers <span class="op">=</span> {}</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._init_base_explainers()</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize explainer for meta-model</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.meta_background_data <span class="op">=</span> <span class="va">self</span>.stack_model.transform(<span class="va">self</span>.background_data)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._init_meta_explainer()</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store expected values for each explainer</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.expected_value <span class="op">=</span> <span class="va">self</span>._get_expected_values()</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _init_base_explainers(<span class="va">self</span>):</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize SHAP explainers for each base model"""</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model_name, model_info <span class="kw">in</span> <span class="va">self</span>.stack_model.models.items():</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> model_info[<span class="st">'model'</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>                features <span class="op">=</span> model_info[<span class="st">'features'</span>]</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> model_info[<span class="st">'model'</span>]</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Sample background data for this model</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>                bg_data <span class="op">=</span> <span class="va">self</span>.background_data[features].values</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Create appropriate explainer based on model type</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(model, lgb.LGBMClassifier):</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.explainers[model_name] <span class="op">=</span> shap.TreeExplainer(model, bg_data)</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> <span class="bu">hasattr</span>(model, <span class="st">"predict_proba"</span>):</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># For models with predict_proba but not LightGBM</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.explainers[model_name] <span class="op">=</span> shap.KernelExplainer(</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>                        model.predict_proba, bg_data</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># For other models</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.explainers[model_name] <span class="op">=</span> shap.KernelExplainer(</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>                        model.predict, bg_data</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _init_meta_explainer(<span class="va">self</span>):</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize SHAP explainer for the meta-model"""</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(<span class="va">self</span>.stack_model.final_estimator, lgb.LGBMClassifier):</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.meta_explainer <span class="op">=</span> shap.TreeExplainer(</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.stack_model.final_estimator, <span class="va">self</span>.meta_background_data</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">hasattr</span>(<span class="va">self</span>.stack_model.final_estimator, <span class="st">"predict_proba"</span>):</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.meta_explainer <span class="op">=</span> shap.KernelExplainer(</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.stack_model.final_estimator.predict_proba, <span class="va">self</span>.meta_background_data</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.meta_explainer <span class="op">=</span> shap.KernelExplainer(</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.stack_model.final_estimator.predict, <span class="va">self</span>.meta_background_data</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_expected_values(<span class="va">self</span>):</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a><span class="co">        Get expected values for all explainers (base models and meta model).</span></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a><span class="co">            dict: Dictionary with expected values for each model</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>        expected_values <span class="op">=</span> {}</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get expected values for base models</span></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model_name, explainer <span class="kw">in</span> <span class="va">self</span>.explainers.items():</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(explainer, <span class="st">'expected_value'</span>):</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>                expected_values[model_name] <span class="op">=</span> explainer.expected_value</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get expected value for meta model</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(<span class="va">self</span>.meta_explainer, <span class="st">'expected_value'</span>):</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>            expected_values[<span class="st">'meta_model'</span>] <span class="op">=</span> <span class="va">self</span>.meta_explainer.expected_value</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> expected_values</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> explain_instance(<span class="va">self</span>, X_instance, target_class<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a><span class="co">        Explain predictions for a single instance using SHAP values throughout the pipeline.</span></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a><span class="co">            X_instance (pd.DataFrame): Single row dataframe with features</span></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a><span class="co">            target_class (int, optional): Class index to explain (for multi-class problems)</span></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a><span class="co">            dict: Dictionary with SHAP explanation information</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(X_instance) <span class="op">!=</span> <span class="dv">1</span>:</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"X_instance must be a single instance (DataFrame with one row)"</span>)</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 1: Get SHAP values for each base model</span></span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>        base_model_shap_values <span class="op">=</span> {}</span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>        base_meta_features <span class="op">=</span> {}</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model_name, model_info <span class="kw">in</span> <span class="va">self</span>.stack_model.models.items():</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>            features <span class="op">=</span> model_info[<span class="st">'features'</span>]</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>            X_model <span class="op">=</span> X_instance[features]</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> model_info[<span class="st">'model'</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Get SHAP values for this base model</span></span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>                model_shap <span class="op">=</span> <span class="va">self</span>.explainers[model_name].shap_values(X_model)</span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>                <span class="co"># For multi-class, handle the list of arrays</span></span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(model_shap, <span class="bu">list</span>):</span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> target_class <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>                        model_shap <span class="op">=</span> model_shap[target_class]</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># If no target class specified, average across classes</span></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>                        model_shap <span class="op">=</span> np.mean(np.array(model_shap), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>                base_model_shap_values[model_name] <span class="op">=</span> {</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'shap_values'</span>: model_shap,</span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'feature_names'</span>: features</span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Get the output of this model (meta-features it produces)</span></span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>                base_meta_features[model_name] <span class="op">=</span> model_info[<span class="st">'model'</span>].predict_proba(X_model)</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>                <span class="co"># For direct features (no model), SHAP values directly affect meta-model</span></span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>                base_meta_features[model_name] <span class="op">=</span> X_model.values</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 2: Get SHAP values for meta-model on transformed features</span></span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>        meta_features <span class="op">=</span> <span class="va">self</span>.stack_model.transform(X_instance)</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>        meta_model_shap <span class="op">=</span> <span class="va">self</span>.meta_explainer.shap_values(meta_features)</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For multi-class, handle the list of arrays</span></span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(meta_model_shap, <span class="bu">list</span>):</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> target_class <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>                meta_model_shap <span class="op">=</span> meta_model_shap[target_class]</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>                <span class="co"># If no target class specified, average across classes</span></span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>                meta_model_shap <span class="op">=</span> np.mean(np.array(meta_model_shap), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Step 3: Apply chain rule to get impact of original features on final prediction</span></span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize dictionary to store combined SHAP values</span></span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>        combined_shap <span class="op">=</span> {}</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>        feature_influence_chain <span class="op">=</span> {}</span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Current meta-feature index in the concatenated meta_features array</span></span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a>        meta_feature_idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model_name, model_info <span class="kw">in</span> <span class="va">self</span>.stack_model.models.items():</span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> model_info[<span class="st">'model'</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>                <span class="co"># This model processes features and produces meta-features</span></span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>                model_contrib <span class="op">=</span> base_model_shap_values[model_name]</span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>                orig_features <span class="op">=</span> model_info[<span class="st">'features'</span>]</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>                n_classes <span class="op">=</span> base_meta_features[model_name].shape[<span class="dv">1</span>]</span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>                <span class="co"># For each original feature in this model</span></span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> i, feature <span class="kw">in</span> <span class="bu">enumerate</span>(orig_features):</span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Initialize if not already present</span></span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> feature <span class="kw">not</span> <span class="kw">in</span> combined_shap:</span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>                        combined_shap[feature] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>                        feature_influence_chain[feature] <span class="op">=</span> {}</span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># For each class output from this model</span></span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> class_idx <span class="kw">in</span> <span class="bu">range</span>(n_classes):</span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Get current meta-feature name</span></span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>                        meta_feat_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_class</span><span class="sc">{</span>class_idx<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Get SHAP value of this meta-feature in the meta-model</span></span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>                        meta_shap_val <span class="op">=</span> meta_model_shap[<span class="dv">0</span>, meta_feature_idx <span class="op">+</span> class_idx]</span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Get influence of original feature on this model's output for this class</span></span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># For multi-class base models</span></span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">isinstance</span>(model_contrib[<span class="st">'shap_values'</span>], <span class="bu">list</span>):</span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>                            base_shap_val <span class="op">=</span> model_contrib[<span class="st">'shap_values'</span>][class_idx][<span class="dv">0</span>, i]</span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a>                            base_shap_val <span class="op">=</span> model_contrib[<span class="st">'shap_values'</span>][<span class="dv">0</span>, i]</span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Chain rule: multiply SHAP values</span></span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a>                        chain_effect <span class="op">=</span> base_shap_val <span class="op">*</span> meta_shap_val</span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>                        combined_shap[feature] <span class="op">+=</span> chain_effect</span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Store the chain of influence for detailed explanation</span></span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> meta_feat_name <span class="kw">not</span> <span class="kw">in</span> feature_influence_chain[feature]:</span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a>                            feature_influence_chain[feature][meta_feat_name] <span class="op">=</span> chain_effect</span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update meta_feature index</span></span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a>                meta_feature_idx <span class="op">+=</span> n_classes</span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a>                <span class="co"># For direct features, get their impact directly from meta-model SHAP values</span></span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a>                orig_features <span class="op">=</span> model_info[<span class="st">'features'</span>]</span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> i, feature <span class="kw">in</span> <span class="bu">enumerate</span>(orig_features):</span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>                    combined_shap[feature] <span class="op">=</span> meta_model_shap[<span class="dv">0</span>, meta_feature_idx <span class="op">+</span> i]</span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a>                    feature_influence_chain[feature] <span class="op">=</span> {</span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a>                        feature: combined_shap[feature]  <span class="co"># Direct influence</span></span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update meta_feature index</span></span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a>                meta_feature_idx <span class="op">+=</span> <span class="bu">len</span>(orig_features)</span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a>            <span class="st">'combined_shap'</span>: combined_shap,</span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a>            <span class="st">'feature_influence_chain'</span>: feature_influence_chain,</span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a>            <span class="st">'meta_model_shap'</span>: meta_model_shap,</span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a>            <span class="st">'base_model_shap'</span>: base_model_shap_values,</span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a>            <span class="st">'meta_features'</span>: meta_features,</span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a>            <span class="st">'expected_value'</span>: <span class="va">self</span>.expected_value</span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_feature_importance_old(<span class="va">self</span>, X, target_class<span class="op">=</span><span class="va">None</span>, top_n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a><span class="co">        Plot overall feature importance across the entire stacking model.</span></span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a><span class="co">            X (pd.DataFrame): Feature matrix to compute importances</span></span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a><span class="co">            target_class (int, optional): Class to explain for multi-class problems</span></span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a><span class="co">            top_n (int): Number of top features to display</span></span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute SHAP values for a sample of instances</span></span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(X) <span class="op">&gt;</span> <span class="dv">100</span>:</span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a>            X_sample <span class="op">=</span> X.sample(<span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a>            X_sample <span class="op">=</span> X</span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a>        all_shap_values <span class="op">=</span> {}</span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each sample, compute combined SHAP values</span></span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(X_sample)):</span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a>            instance <span class="op">=</span> X_sample.iloc[[i]]</span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a>            explanation <span class="op">=</span> <span class="va">self</span>.explain_instance(instance, target_class)</span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Aggregate SHAP values across samples</span></span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> feature, shap_val <span class="kw">in</span> explanation[<span class="st">'combined_shap'</span>].items():</span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> feature <span class="kw">not</span> <span class="kw">in</span> all_shap_values:</span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a>                    all_shap_values[feature] <span class="op">=</span> []</span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a>                all_shap_values[feature].append(shap_val)</span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute mean absolute SHAP value for each feature</span></span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a>        mean_abs_shap <span class="op">=</span> {feat: np.mean(np.<span class="bu">abs</span>(vals)) <span class="cf">for</span> feat, vals <span class="kw">in</span> all_shap_values.items()}</span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sort features by importance</span></span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a>        sorted_features <span class="op">=</span> <span class="bu">sorted</span>(mean_abs_shap.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get top N features</span></span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a>        top_features <span class="op">=</span> sorted_features[:top_n]</span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create plot</span></span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a>        features, values <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>top_features)</span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a>        plt.barh(<span class="bu">range</span>(<span class="bu">len</span>(features)), values, align<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a>        plt.yticks(<span class="bu">range</span>(<span class="bu">len</span>(features)), features)</span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Mean |SHAP Value|'</span>)</span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'Top </span><span class="sc">{</span>top_n<span class="sc">}</span><span class="ss"> Features (Stacking Model Pipeline)'</span>)</span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mean_abs_shap</span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_feature_importance(<span class="va">self</span>, X, target_class<span class="op">=</span><span class="va">None</span>, top_n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb11-282"><a href="#cb11-282" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb11-283"><a href="#cb11-283" aria-hidden="true" tabindex="-1"></a><span class="co">        Plot overall feature importance across the entire stacking model.</span></span>
<span id="cb11-284"><a href="#cb11-284" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb11-285"><a href="#cb11-285" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb11-286"><a href="#cb11-286" aria-hidden="true" tabindex="-1"></a><span class="co">            X (pd.DataFrame): Feature matrix to compute importances</span></span>
<span id="cb11-287"><a href="#cb11-287" aria-hidden="true" tabindex="-1"></a><span class="co">            target_class (int, optional): Class to explain for multi-class problems</span></span>
<span id="cb11-288"><a href="#cb11-288" aria-hidden="true" tabindex="-1"></a><span class="co">            top_n (int): Number of top features to display</span></span>
<span id="cb11-289"><a href="#cb11-289" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb11-290"><a href="#cb11-290" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute SHAP values for a sample of instances</span></span>
<span id="cb11-291"><a href="#cb11-291" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(X) <span class="op">&gt;</span> <span class="dv">100</span>:</span>
<span id="cb11-292"><a href="#cb11-292" aria-hidden="true" tabindex="-1"></a>            X_sample <span class="op">=</span> X.sample(<span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb11-293"><a href="#cb11-293" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-294"><a href="#cb11-294" aria-hidden="true" tabindex="-1"></a>            X_sample <span class="op">=</span> X</span>
<span id="cb11-295"><a href="#cb11-295" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-296"><a href="#cb11-296" aria-hidden="true" tabindex="-1"></a>        all_shap_values <span class="op">=</span> {}</span>
<span id="cb11-297"><a href="#cb11-297" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-298"><a href="#cb11-298" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each sample, compute combined SHAP values</span></span>
<span id="cb11-299"><a href="#cb11-299" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(X_sample)):</span>
<span id="cb11-300"><a href="#cb11-300" aria-hidden="true" tabindex="-1"></a>            instance <span class="op">=</span> X_sample.iloc[[i]]</span>
<span id="cb11-301"><a href="#cb11-301" aria-hidden="true" tabindex="-1"></a>            explanation <span class="op">=</span> <span class="va">self</span>.explain_instance(instance, target_class)</span>
<span id="cb11-302"><a href="#cb11-302" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-303"><a href="#cb11-303" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Aggregate SHAP values across samples</span></span>
<span id="cb11-304"><a href="#cb11-304" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> feature, shap_val <span class="kw">in</span> explanation[<span class="st">'combined_shap'</span>].items():</span>
<span id="cb11-305"><a href="#cb11-305" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> feature <span class="kw">not</span> <span class="kw">in</span> all_shap_values:</span>
<span id="cb11-306"><a href="#cb11-306" aria-hidden="true" tabindex="-1"></a>                    all_shap_values[feature] <span class="op">=</span> []</span>
<span id="cb11-307"><a href="#cb11-307" aria-hidden="true" tabindex="-1"></a>                all_shap_values[feature].append(shap_val)</span>
<span id="cb11-308"><a href="#cb11-308" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-309"><a href="#cb11-309" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute mean absolute SHAP value for each feature</span></span>
<span id="cb11-310"><a href="#cb11-310" aria-hidden="true" tabindex="-1"></a>        mean_abs_shap <span class="op">=</span> {feat: np.mean(np.<span class="bu">abs</span>(vals)) <span class="cf">for</span> feat, vals <span class="kw">in</span> all_shap_values.items()}</span>
<span id="cb11-311"><a href="#cb11-311" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-312"><a href="#cb11-312" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sort features by importance</span></span>
<span id="cb11-313"><a href="#cb11-313" aria-hidden="true" tabindex="-1"></a>        sorted_features <span class="op">=</span> <span class="bu">sorted</span>(mean_abs_shap.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-314"><a href="#cb11-314" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-315"><a href="#cb11-315" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get top N features</span></span>
<span id="cb11-316"><a href="#cb11-316" aria-hidden="true" tabindex="-1"></a>        top_features <span class="op">=</span> sorted_features[:top_n]</span>
<span id="cb11-317"><a href="#cb11-317" aria-hidden="true" tabindex="-1"></a>        features, values <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>top_features)</span>
<span id="cb11-318"><a href="#cb11-318" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-319"><a href="#cb11-319" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign feature groups based on model_configs</span></span>
<span id="cb11-320"><a href="#cb11-320" aria-hidden="true" tabindex="-1"></a>        feature_to_model <span class="op">=</span> {}</span>
<span id="cb11-321"><a href="#cb11-321" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model_name, config <span class="kw">in</span> <span class="va">self</span>.stack_model.model_configs.items():</span>
<span id="cb11-322"><a href="#cb11-322" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> feat <span class="kw">in</span> config[<span class="st">'feature_names'</span>]:</span>
<span id="cb11-323"><a href="#cb11-323" aria-hidden="true" tabindex="-1"></a>                feature_to_model[feat] <span class="op">=</span> model_name</span>
<span id="cb11-324"><a href="#cb11-324" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Features not belonging to any base model are labeled as "meta"</span></span>
<span id="cb11-325"><a href="#cb11-325" aria-hidden="true" tabindex="-1"></a>        feature_groups <span class="op">=</span> [feature_to_model.get(feat, <span class="st">"meta"</span>) <span class="cf">for</span> feat <span class="kw">in</span> features]</span>
<span id="cb11-326"><a href="#cb11-326" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-327"><a href="#cb11-327" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create plot</span></span>
<span id="cb11-328"><a href="#cb11-328" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))        </span>
<span id="cb11-329"><a href="#cb11-329" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-330"><a href="#cb11-330" aria-hidden="true" tabindex="-1"></a>        feature_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb11-331"><a href="#cb11-331" aria-hidden="true" tabindex="-1"></a>            <span class="st">'feature'</span>: features,</span>
<span id="cb11-332"><a href="#cb11-332" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_abs_shap'</span>: values,</span>
<span id="cb11-333"><a href="#cb11-333" aria-hidden="true" tabindex="-1"></a>            <span class="st">'group'</span>: feature_groups</span>
<span id="cb11-334"><a href="#cb11-334" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb11-335"><a href="#cb11-335" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-336"><a href="#cb11-336" aria-hidden="true" tabindex="-1"></a>        sns.barplot(data<span class="op">=</span>feature_df, x<span class="op">=</span><span class="st">'mean_abs_shap'</span>, y<span class="op">=</span><span class="st">'feature'</span>, hue<span class="op">=</span><span class="st">'group'</span>, dodge<span class="op">=</span><span class="va">False</span>, palette<span class="op">=</span><span class="st">'Set2'</span>)</span>
<span id="cb11-337"><a href="#cb11-337" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-338"><a href="#cb11-338" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Mean |SHAP Value|'</span>)</span>
<span id="cb11-339"><a href="#cb11-339" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'Top </span><span class="sc">{</span>top_n<span class="sc">}</span><span class="ss"> Features (Stacking Model Pipeline)'</span>)</span>
<span id="cb11-340"><a href="#cb11-340" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb11-341"><a href="#cb11-341" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb11-342"><a href="#cb11-342" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-343"><a href="#cb11-343" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mean_abs_shap</span>
<span id="cb11-344"><a href="#cb11-344" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-345"><a href="#cb11-345" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> visualize_prediction_path(<span class="va">self</span>, X_instance, target_class<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb11-346"><a href="#cb11-346" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb11-347"><a href="#cb11-347" aria-hidden="true" tabindex="-1"></a><span class="co">        Create a visualization showing how features flow through the model to affect prediction.</span></span>
<span id="cb11-348"><a href="#cb11-348" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb11-349"><a href="#cb11-349" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb11-350"><a href="#cb11-350" aria-hidden="true" tabindex="-1"></a><span class="co">            X_instance (pd.DataFrame): Single instance to explain</span></span>
<span id="cb11-351"><a href="#cb11-351" aria-hidden="true" tabindex="-1"></a><span class="co">            target_class (int, optional): Class to explain for multi-class problems</span></span>
<span id="cb11-352"><a href="#cb11-352" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb11-353"><a href="#cb11-353" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(X_instance) <span class="op">!=</span> <span class="dv">1</span>:</span>
<span id="cb11-354"><a href="#cb11-354" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"X_instance must be a single instance (DataFrame with one row)"</span>)</span>
<span id="cb11-355"><a href="#cb11-355" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-356"><a href="#cb11-356" aria-hidden="true" tabindex="-1"></a>        explanation <span class="op">=</span> <span class="va">self</span>.explain_instance(X_instance, target_class)</span>
<span id="cb11-357"><a href="#cb11-357" aria-hidden="true" tabindex="-1"></a>        feature_chains <span class="op">=</span> explanation[<span class="st">'feature_influence_chain'</span>]</span>
<span id="cb11-358"><a href="#cb11-358" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-359"><a href="#cb11-359" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create plot</span></span>
<span id="cb11-360"><a href="#cb11-360" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">12</span>))</span>
<span id="cb11-361"><a href="#cb11-361" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-362"><a href="#cb11-362" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine feature ordering by importance</span></span>
<span id="cb11-363"><a href="#cb11-363" aria-hidden="true" tabindex="-1"></a>        feature_importance <span class="op">=</span> {f: np.<span class="bu">abs</span>(<span class="bu">sum</span>(vals.values())) <span class="cf">for</span> f, vals <span class="kw">in</span> feature_chains.items()}</span>
<span id="cb11-364"><a href="#cb11-364" aria-hidden="true" tabindex="-1"></a>        sorted_features <span class="op">=</span> <span class="bu">sorted</span>(feature_importance.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-365"><a href="#cb11-365" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> [f[<span class="dv">0</span>] <span class="cf">for</span> f <span class="kw">in</span> sorted_features]</span>
<span id="cb11-366"><a href="#cb11-366" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-367"><a href="#cb11-367" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limit to top features for readability</span></span>
<span id="cb11-368"><a href="#cb11-368" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(features) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb11-369"><a href="#cb11-369" aria-hidden="true" tabindex="-1"></a>            features <span class="op">=</span> features[:<span class="dv">10</span>]</span>
<span id="cb11-370"><a href="#cb11-370" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-371"><a href="#cb11-371" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define color mapping for legend</span></span>
<span id="cb11-372"><a href="#cb11-372" aria-hidden="true" tabindex="-1"></a>        color_mapping <span class="op">=</span> {</span>
<span id="cb11-373"><a href="#cb11-373" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Negative Contribution'</span>: <span class="st">'#008BFB'</span>,  <span class="co"># Blue for negative SHAP values</span></span>
<span id="cb11-374"><a href="#cb11-374" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Positive Contribution'</span>: <span class="st">'#FF0051'</span>  <span class="co"># Red for positive SHAP values</span></span>
<span id="cb11-375"><a href="#cb11-375" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb11-376"><a href="#cb11-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-377"><a href="#cb11-377" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a grid of plots - one row per feature</span></span>
<span id="cb11-378"><a href="#cb11-378" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, feature <span class="kw">in</span> <span class="bu">enumerate</span>(features):</span>
<span id="cb11-379"><a href="#cb11-379" aria-hidden="true" tabindex="-1"></a>            plt.subplot(<span class="bu">len</span>(features), <span class="dv">1</span>, i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb11-380"><a href="#cb11-380" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-381"><a href="#cb11-381" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get intermediate influences for this feature</span></span>
<span id="cb11-382"><a href="#cb11-382" aria-hidden="true" tabindex="-1"></a>            influences <span class="op">=</span> feature_chains[feature]</span>
<span id="cb11-383"><a href="#cb11-383" aria-hidden="true" tabindex="-1"></a>            meta_features <span class="op">=</span> <span class="bu">list</span>(influences.keys())</span>
<span id="cb11-384"><a href="#cb11-384" aria-hidden="true" tabindex="-1"></a>            values <span class="op">=</span> <span class="bu">list</span>(influences.values())</span>
<span id="cb11-385"><a href="#cb11-385" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-386"><a href="#cb11-386" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Sort by absolute value</span></span>
<span id="cb11-387"><a href="#cb11-387" aria-hidden="true" tabindex="-1"></a>            sorted_idx <span class="op">=</span> np.argsort(np.<span class="bu">abs</span>(values))[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-388"><a href="#cb11-388" aria-hidden="true" tabindex="-1"></a>            meta_features <span class="op">=</span> [meta_features[j] <span class="cf">for</span> j <span class="kw">in</span> sorted_idx]</span>
<span id="cb11-389"><a href="#cb11-389" aria-hidden="true" tabindex="-1"></a>            values <span class="op">=</span> [values[j] <span class="cf">for</span> j <span class="kw">in</span> sorted_idx]</span>
<span id="cb11-390"><a href="#cb11-390" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-391"><a href="#cb11-391" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Limit to top 5 intermediate influences for readability</span></span>
<span id="cb11-392"><a href="#cb11-392" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(meta_features) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb11-393"><a href="#cb11-393" aria-hidden="true" tabindex="-1"></a>                meta_features <span class="op">=</span> meta_features[:<span class="dv">5</span>]</span>
<span id="cb11-394"><a href="#cb11-394" aria-hidden="true" tabindex="-1"></a>                values <span class="op">=</span> values[:<span class="dv">5</span>]</span>
<span id="cb11-395"><a href="#cb11-395" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-396"><a href="#cb11-396" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create bar chart</span></span>
<span id="cb11-397"><a href="#cb11-397" aria-hidden="true" tabindex="-1"></a>            bars <span class="op">=</span> plt.barh(meta_features, values, align<span class="op">=</span><span class="st">'center'</span>)</span>
<span id="cb11-398"><a href="#cb11-398" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-399"><a href="#cb11-399" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Color positive and negative contributions differently</span></span>
<span id="cb11-400"><a href="#cb11-400" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j, bar <span class="kw">in</span> <span class="bu">enumerate</span>(bars):</span>
<span id="cb11-401"><a href="#cb11-401" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> values[j] <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb11-402"><a href="#cb11-402" aria-hidden="true" tabindex="-1"></a>                    bar.set_color(<span class="st">'#008BFB'</span>)</span>
<span id="cb11-403"><a href="#cb11-403" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb11-404"><a href="#cb11-404" aria-hidden="true" tabindex="-1"></a>                    bar.set_color(<span class="st">'#FF0051'</span>)</span>
<span id="cb11-405"><a href="#cb11-405" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-406"><a href="#cb11-406" aria-hidden="true" tabindex="-1"></a>            plt.axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb11-407"><a href="#cb11-407" aria-hidden="true" tabindex="-1"></a>            plt.title(<span class="ss">f"Feature: </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">"</span>)            </span>
<span id="cb11-408"><a href="#cb11-408" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-409"><a href="#cb11-409" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add a single legend at the bottom of the figure        </span></span>
<span id="cb11-410"><a href="#cb11-410" aria-hidden="true" tabindex="-1"></a>        legend_elements <span class="op">=</span> [</span>
<span id="cb11-411"><a href="#cb11-411" aria-hidden="true" tabindex="-1"></a>            Patch(facecolor<span class="op">=</span>color_mapping[<span class="st">'Negative Contribution'</span>], edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Negative Contribution'</span>),</span>
<span id="cb11-412"><a href="#cb11-412" aria-hidden="true" tabindex="-1"></a>            Patch(facecolor<span class="op">=</span>color_mapping[<span class="st">'Positive Contribution'</span>], edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Positive Contribution'</span>)</span>
<span id="cb11-413"><a href="#cb11-413" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb11-414"><a href="#cb11-414" aria-hidden="true" tabindex="-1"></a>        plt.figlegend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'lower center'</span>, ncol<span class="op">=</span><span class="dv">2</span>, frameon<span class="op">=</span><span class="va">False</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-415"><a href="#cb11-415" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-416"><a href="#cb11-416" aria-hidden="true" tabindex="-1"></a>        plt.suptitle(<span class="st">"SHAP Value Contribution"</span>)</span>
<span id="cb11-417"><a href="#cb11-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-418"><a href="#cb11-418" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="fl">0.03</span>, <span class="dv">1</span>, <span class="fl">0.95</span>])  <span class="co"># Adjust layout to make space for the legend</span></span>
<span id="cb11-419"><a href="#cb11-419" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb11-420"><a href="#cb11-420" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-421"><a href="#cb11-421" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> explanation</span>
<span id="cb11-422"><a href="#cb11-422" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-423"><a href="#cb11-423" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> plot_waterfall(<span class="va">self</span>, X_instance, target_class<span class="op">=</span><span class="va">None</span>, max_features<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb11-424"><a href="#cb11-424" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb11-425"><a href="#cb11-425" aria-hidden="true" tabindex="-1"></a><span class="co">        Create a waterfall plot showing how each feature's SHAP value influences</span></span>
<span id="cb11-426"><a href="#cb11-426" aria-hidden="true" tabindex="-1"></a><span class="co">        the prediction for a single observation.</span></span>
<span id="cb11-427"><a href="#cb11-427" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb11-428"><a href="#cb11-428" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb11-429"><a href="#cb11-429" aria-hidden="true" tabindex="-1"></a><span class="co">            X_instance (pd.DataFrame): Single row dataframe with features to explain</span></span>
<span id="cb11-430"><a href="#cb11-430" aria-hidden="true" tabindex="-1"></a><span class="co">            target_class (int, optional): Class index to explain (for multi-class problems)</span></span>
<span id="cb11-431"><a href="#cb11-431" aria-hidden="true" tabindex="-1"></a><span class="co">            max_features (int): Maximum number of features to display in the plot</span></span>
<span id="cb11-432"><a href="#cb11-432" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb11-433"><a href="#cb11-433" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb11-434"><a href="#cb11-434" aria-hidden="true" tabindex="-1"></a><span class="co">            tuple: (figure, axes) matplotlib figure and axes objects</span></span>
<span id="cb11-435"><a href="#cb11-435" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb11-436"><a href="#cb11-436" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(X_instance) <span class="op">!=</span> <span class="dv">1</span>:</span>
<span id="cb11-437"><a href="#cb11-437" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"X_instance must be a single instance (DataFrame with one row)"</span>)</span>
<span id="cb11-438"><a href="#cb11-438" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-439"><a href="#cb11-439" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get explanation for the instance</span></span>
<span id="cb11-440"><a href="#cb11-440" aria-hidden="true" tabindex="-1"></a>        explanation <span class="op">=</span> <span class="va">self</span>.explain_instance(X_instance, target_class)</span>
<span id="cb11-441"><a href="#cb11-441" aria-hidden="true" tabindex="-1"></a>        combined_shap <span class="op">=</span> explanation[<span class="st">'combined_shap'</span>]</span>
<span id="cb11-442"><a href="#cb11-442" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-443"><a href="#cb11-443" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get expected value (baseline) for meta model</span></span>
<span id="cb11-444"><a href="#cb11-444" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> target_class <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="bu">isinstance</span>(<span class="va">self</span>.expected_value[<span class="st">'meta_model'</span>], <span class="bu">list</span>):</span>
<span id="cb11-445"><a href="#cb11-445" aria-hidden="true" tabindex="-1"></a>            baseline <span class="op">=</span> <span class="va">self</span>.expected_value[<span class="st">'meta_model'</span>][target_class]</span>
<span id="cb11-446"><a href="#cb11-446" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-447"><a href="#cb11-447" aria-hidden="true" tabindex="-1"></a>            baseline <span class="op">=</span> <span class="va">self</span>.expected_value[<span class="st">'meta_model'</span>]</span>
<span id="cb11-448"><a href="#cb11-448" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-449"><a href="#cb11-449" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(baseline, np.ndarray) <span class="kw">and</span> baseline.size <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb11-450"><a href="#cb11-450" aria-hidden="true" tabindex="-1"></a>            baseline <span class="op">=</span> baseline[<span class="dv">0</span>]</span>
<span id="cb11-451"><a href="#cb11-451" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-452"><a href="#cb11-452" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sort features by absolute SHAP value</span></span>
<span id="cb11-453"><a href="#cb11-453" aria-hidden="true" tabindex="-1"></a>        sorted_features <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb11-454"><a href="#cb11-454" aria-hidden="true" tabindex="-1"></a>            [(feat, val) <span class="cf">for</span> feat, val <span class="kw">in</span> combined_shap.items()],</span>
<span id="cb11-455"><a href="#cb11-455" aria-hidden="true" tabindex="-1"></a>            key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">abs</span>(x[<span class="dv">1</span>]),</span>
<span id="cb11-456"><a href="#cb11-456" aria-hidden="true" tabindex="-1"></a>            reverse<span class="op">=</span><span class="va">True</span></span>
<span id="cb11-457"><a href="#cb11-457" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-458"><a href="#cb11-458" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-459"><a href="#cb11-459" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limit to max_features</span></span>
<span id="cb11-460"><a href="#cb11-460" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(sorted_features) <span class="op">&gt;</span> max_features:</span>
<span id="cb11-461"><a href="#cb11-461" aria-hidden="true" tabindex="-1"></a>            top_features <span class="op">=</span> sorted_features[:max_features<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-462"><a href="#cb11-462" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Combine remaining features into "other"</span></span>
<span id="cb11-463"><a href="#cb11-463" aria-hidden="true" tabindex="-1"></a>            other_impact <span class="op">=</span> <span class="bu">sum</span>(val <span class="cf">for</span> _, val <span class="kw">in</span> sorted_features[max_features<span class="op">-</span><span class="dv">1</span>:])</span>
<span id="cb11-464"><a href="#cb11-464" aria-hidden="true" tabindex="-1"></a>            top_features.append((<span class="st">"Other features"</span>, other_impact))</span>
<span id="cb11-465"><a href="#cb11-465" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-466"><a href="#cb11-466" aria-hidden="true" tabindex="-1"></a>            top_features <span class="op">=</span> sorted_features</span>
<span id="cb11-467"><a href="#cb11-467" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-468"><a href="#cb11-468" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create lists for plotting</span></span>
<span id="cb11-469"><a href="#cb11-469" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> [item[<span class="dv">0</span>] <span class="cf">for</span> item <span class="kw">in</span> top_features]</span>
<span id="cb11-470"><a href="#cb11-470" aria-hidden="true" tabindex="-1"></a>        impacts <span class="op">=</span> [item[<span class="dv">1</span>] <span class="cf">for</span> item <span class="kw">in</span> top_features]</span>
<span id="cb11-471"><a href="#cb11-471" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-472"><a href="#cb11-472" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate final prediction</span></span>
<span id="cb11-473"><a href="#cb11-473" aria-hidden="true" tabindex="-1"></a>        final_prediction <span class="op">=</span> baseline <span class="op">+</span> <span class="bu">sum</span>(impacts)</span>
<span id="cb11-474"><a href="#cb11-474" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-475"><a href="#cb11-475" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create figure and axes</span></span>
<span id="cb11-476"><a href="#cb11-476" aria-hidden="true" tabindex="-1"></a>        fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">7</span>))</span>
<span id="cb11-477"><a href="#cb11-477" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-478"><a href="#cb11-478" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define colors for positive and negative contributions</span></span>
<span id="cb11-479"><a href="#cb11-479" aria-hidden="true" tabindex="-1"></a>        colors <span class="op">=</span> [<span class="st">'#FF0051'</span> <span class="cf">if</span> x <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'#008BFB'</span> <span class="cf">for</span> x <span class="kw">in</span> impacts]</span>
<span id="cb11-480"><a href="#cb11-480" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-481"><a href="#cb11-481" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate positions for waterfall bars</span></span>
<span id="cb11-482"><a href="#cb11-482" aria-hidden="true" tabindex="-1"></a>        positions <span class="op">=</span> np.zeros(<span class="bu">len</span>(impacts) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb11-483"><a href="#cb11-483" aria-hidden="true" tabindex="-1"></a>        positions[<span class="dv">0</span>] <span class="op">=</span> baseline</span>
<span id="cb11-484"><a href="#cb11-484" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(impacts)):</span>
<span id="cb11-485"><a href="#cb11-485" aria-hidden="true" tabindex="-1"></a>            positions[i<span class="op">+</span><span class="dv">1</span>] <span class="op">=</span> positions[i] <span class="op">+</span> impacts[i]</span>
<span id="cb11-486"><a href="#cb11-486" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-487"><a href="#cb11-487" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot waterfall chart</span></span>
<span id="cb11-488"><a href="#cb11-488" aria-hidden="true" tabindex="-1"></a>        <span class="co"># First bar (baseline)</span></span>
<span id="cb11-489"><a href="#cb11-489" aria-hidden="true" tabindex="-1"></a>        ax.bar(<span class="dv">0</span>, baseline, bottom<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'#BBBBBB'</span>, width<span class="op">=</span><span class="fl">0.6</span>, </span>
<span id="cb11-490"><a href="#cb11-490" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Baseline (Expected Value)'</span>)</span>
<span id="cb11-491"><a href="#cb11-491" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-492"><a href="#cb11-492" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Feature impact bars</span></span>
<span id="cb11-493"><a href="#cb11-493" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, impact <span class="kw">in</span> <span class="bu">enumerate</span>(impacts):</span>
<span id="cb11-494"><a href="#cb11-494" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For each feature impact, plot a bar from the previous cumulative position</span></span>
<span id="cb11-495"><a href="#cb11-495" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Bottom of each bar is the previous cumulative position</span></span>
<span id="cb11-496"><a href="#cb11-496" aria-hidden="true" tabindex="-1"></a>            bottom <span class="op">=</span> positions[i] <span class="op">-</span> <span class="bu">max</span>(<span class="dv">0</span>, impact)</span>
<span id="cb11-497"><a href="#cb11-497" aria-hidden="true" tabindex="-1"></a>            height <span class="op">=</span> <span class="bu">abs</span>(impact)</span>
<span id="cb11-498"><a href="#cb11-498" aria-hidden="true" tabindex="-1"></a>            ax.bar(i<span class="op">+</span><span class="dv">1</span>, height, bottom<span class="op">=</span>bottom, color<span class="op">=</span>colors[i], width<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb11-499"><a href="#cb11-499" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-500"><a href="#cb11-500" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Final prediction bar</span></span>
<span id="cb11-501"><a href="#cb11-501" aria-hidden="true" tabindex="-1"></a>        ax.bar(<span class="bu">len</span>(impacts)<span class="op">+</span><span class="dv">1</span>, final_prediction, bottom<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'#32CD32'</span>, width<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb11-502"><a href="#cb11-502" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Final Prediction'</span>)</span>
<span id="cb11-503"><a href="#cb11-503" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-504"><a href="#cb11-504" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Connect bars with lines</span></span>
<span id="cb11-505"><a href="#cb11-505" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(positions)<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb11-506"><a href="#cb11-506" aria-hidden="true" tabindex="-1"></a>            ax.plot([i<span class="op">+</span><span class="fl">0.3</span>, i<span class="op">+</span><span class="fl">0.7</span>], [positions[i], positions[i]], <span class="st">'k-'</span>, lw<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb11-507"><a href="#cb11-507" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-508"><a href="#cb11-508" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Annotate bars with feature names and values</span></span>
<span id="cb11-509"><a href="#cb11-509" aria-hidden="true" tabindex="-1"></a>        ax.set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(impacts) <span class="op">+</span> <span class="dv">2</span>))</span>
<span id="cb11-510"><a href="#cb11-510" aria-hidden="true" tabindex="-1"></a>        xlabels <span class="op">=</span> [<span class="st">'Baseline'</span>] <span class="op">+</span> features <span class="op">+</span> [<span class="st">'Prediction'</span>]</span>
<span id="cb11-511"><a href="#cb11-511" aria-hidden="true" tabindex="-1"></a>        ax.set_xticklabels(xlabels, rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb11-512"><a href="#cb11-512" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-513"><a href="#cb11-513" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add value labels to the bars</span></span>
<span id="cb11-514"><a href="#cb11-514" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, pos <span class="kw">in</span> <span class="bu">enumerate</span>(positions):</span>
<span id="cb11-515"><a href="#cb11-515" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb11-516"><a href="#cb11-516" aria-hidden="true" tabindex="-1"></a>                ax.text(i, pos <span class="op">+</span> <span class="fl">0.01</span>, <span class="ss">f'</span><span class="sc">{</span>baseline<span class="sc">:.3f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>)</span>
<span id="cb11-517"><a href="#cb11-517" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> i <span class="op">==</span> <span class="bu">len</span>(positions) <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb11-518"><a href="#cb11-518" aria-hidden="true" tabindex="-1"></a>                ax.text(i, pos <span class="op">+</span> <span class="fl">0.01</span>, <span class="ss">f'</span><span class="sc">{</span>pos<span class="sc">:.3f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>)</span>
<span id="cb11-519"><a href="#cb11-519" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-520"><a href="#cb11-520" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add impact values as text</span></span>
<span id="cb11-521"><a href="#cb11-521" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, impact <span class="kw">in</span> <span class="bu">enumerate</span>(impacts):</span>
<span id="cb11-522"><a href="#cb11-522" aria-hidden="true" tabindex="-1"></a>            ax.text(i<span class="op">+</span><span class="dv">1</span>, positions[i] <span class="op">+</span> impact<span class="op">/</span><span class="dv">2</span>, <span class="ss">f'</span><span class="sc">{</span>impact<span class="sc">:.3f}</span><span class="ss">'</span>, </span>
<span id="cb11-523"><a href="#cb11-523" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, weight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb11-524"><a href="#cb11-524" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'white'</span> <span class="cf">if</span> <span class="bu">abs</span>(impact) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="cf">else</span> <span class="st">'black'</span>)</span>
<span id="cb11-525"><a href="#cb11-525" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-526"><a href="#cb11-526" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add a title and axis labels</span></span>
<span id="cb11-527"><a href="#cb11-527" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> target_class <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-528"><a href="#cb11-528" aria-hidden="true" tabindex="-1"></a>            ax.set_title(<span class="ss">f'Feature Contributions to Prediction (Class </span><span class="sc">{</span>target_class<span class="sc">}</span><span class="ss">)'</span>)</span>
<span id="cb11-529"><a href="#cb11-529" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-530"><a href="#cb11-530" aria-hidden="true" tabindex="-1"></a>            ax.set_title(<span class="st">'Feature Contributions to Prediction'</span>)</span>
<span id="cb11-531"><a href="#cb11-531" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-532"><a href="#cb11-532" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">'Model Output'</span>)</span>
<span id="cb11-533"><a href="#cb11-533" aria-hidden="true" tabindex="-1"></a>        ax.grid(axis<span class="op">=</span><span class="st">'y'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb11-534"><a href="#cb11-534" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-535"><a href="#cb11-535" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create custom legend</span></span>
<span id="cb11-536"><a href="#cb11-536" aria-hidden="true" tabindex="-1"></a>        legend_elements <span class="op">=</span> [</span>
<span id="cb11-537"><a href="#cb11-537" aria-hidden="true" tabindex="-1"></a>            Patch(facecolor<span class="op">=</span><span class="st">'#BBBBBB'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Baseline'</span>),</span>
<span id="cb11-538"><a href="#cb11-538" aria-hidden="true" tabindex="-1"></a>            Patch(facecolor<span class="op">=</span><span class="st">'#FF0051'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Positive Impact'</span>),</span>
<span id="cb11-539"><a href="#cb11-539" aria-hidden="true" tabindex="-1"></a>            Patch(facecolor<span class="op">=</span><span class="st">'#008BFB'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Negative Impact'</span>),</span>
<span id="cb11-540"><a href="#cb11-540" aria-hidden="true" tabindex="-1"></a>            Patch(facecolor<span class="op">=</span><span class="st">'#32CD32'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Final Prediction'</span>)</span>
<span id="cb11-541"><a href="#cb11-541" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb11-542"><a href="#cb11-542" aria-hidden="true" tabindex="-1"></a>        ax.legend(handles<span class="op">=</span>legend_elements, loc<span class="op">=</span><span class="st">'best'</span>)</span>
<span id="cb11-543"><a href="#cb11-543" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-544"><a href="#cb11-544" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb11-545"><a href="#cb11-545" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-546"><a href="#cb11-546" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fig, ax</span>
<span id="cb11-547"><a href="#cb11-547" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-548"><a href="#cb11-548" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_feature_influence(<span class="va">self</span>, explanation, feature_name):</span>
<span id="cb11-549"><a href="#cb11-549" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb11-550"><a href="#cb11-550" aria-hidden="true" tabindex="-1"></a><span class="co">        Extract the influence of a specific feature to the final prediction</span></span>
<span id="cb11-551"><a href="#cb11-551" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb11-552"><a href="#cb11-552" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb11-553"><a href="#cb11-553" aria-hidden="true" tabindex="-1"></a><span class="co">            explanation (dict): The explanation dict from explain_instance</span></span>
<span id="cb11-554"><a href="#cb11-554" aria-hidden="true" tabindex="-1"></a><span class="co">            feature_name (str): Name of the feature to get influence for</span></span>
<span id="cb11-555"><a href="#cb11-555" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb11-556"><a href="#cb11-556" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb11-557"><a href="#cb11-557" aria-hidden="true" tabindex="-1"></a><span class="co">            dict: Dictionary containing influence details</span></span>
<span id="cb11-558"><a href="#cb11-558" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb11-559"><a href="#cb11-559" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> feature_name <span class="kw">not</span> <span class="kw">in</span> explanation[<span class="st">'combined_shap'</span>]:</span>
<span id="cb11-560"><a href="#cb11-560" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Feature '</span><span class="sc">{</span>feature_name<span class="sc">}</span><span class="ss">' not found in explanation!"</span>)</span>
<span id="cb11-561"><a href="#cb11-561" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb11-562"><a href="#cb11-562" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-563"><a href="#cb11-563" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the combined SHAP value (total influence on final prediction)</span></span>
<span id="cb11-564"><a href="#cb11-564" aria-hidden="true" tabindex="-1"></a>        combined_shap <span class="op">=</span> explanation[<span class="st">'combined_shap'</span>][feature_name]</span>
<span id="cb11-565"><a href="#cb11-565" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-566"><a href="#cb11-566" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the detailed influence chain (how the feature affects various meta-features)</span></span>
<span id="cb11-567"><a href="#cb11-567" aria-hidden="true" tabindex="-1"></a>        influence_chain <span class="op">=</span> explanation[<span class="st">'feature_influence_chain'</span>][feature_name]</span>
<span id="cb11-568"><a href="#cb11-568" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-569"><a href="#cb11-569" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find which base model contains this feature</span></span>
<span id="cb11-570"><a href="#cb11-570" aria-hidden="true" tabindex="-1"></a>        model_name <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-571"><a href="#cb11-571" aria-hidden="true" tabindex="-1"></a>        feature_index <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-572"><a href="#cb11-572" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-573"><a href="#cb11-573" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This requires access to the stack_model object, which isn't in the explanation dict</span></span>
<span id="cb11-574"><a href="#cb11-574" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We can extract this information from the base_model_shap if available</span></span>
<span id="cb11-575"><a href="#cb11-575" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> m_name, shap_info <span class="kw">in</span> explanation[<span class="st">'base_model_shap'</span>].items():</span>
<span id="cb11-576"><a href="#cb11-576" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> feature_name <span class="kw">in</span> shap_info[<span class="st">'feature_names'</span>]:</span>
<span id="cb11-577"><a href="#cb11-577" aria-hidden="true" tabindex="-1"></a>                model_name <span class="op">=</span> m_name</span>
<span id="cb11-578"><a href="#cb11-578" aria-hidden="true" tabindex="-1"></a>                feature_index <span class="op">=</span> shap_info[<span class="st">'feature_names'</span>].index(feature_name)</span>
<span id="cb11-579"><a href="#cb11-579" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb11-580"><a href="#cb11-580" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-581"><a href="#cb11-581" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get base model SHAP values for this feature</span></span>
<span id="cb11-582"><a href="#cb11-582" aria-hidden="true" tabindex="-1"></a>        base_model_shap <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-583"><a href="#cb11-583" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> model_name <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> feature_index <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-584"><a href="#cb11-584" aria-hidden="true" tabindex="-1"></a>            base_shap <span class="op">=</span> explanation[<span class="st">'base_model_shap'</span>][model_name][<span class="st">'shap_values'</span>]</span>
<span id="cb11-585"><a href="#cb11-585" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-586"><a href="#cb11-586" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle multi-class base models</span></span>
<span id="cb11-587"><a href="#cb11-587" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(base_shap, <span class="bu">list</span>):</span>
<span id="cb11-588"><a href="#cb11-588" aria-hidden="true" tabindex="-1"></a>                base_model_shap <span class="op">=</span> [shap_vals[<span class="dv">0</span>, feature_index] <span class="cf">for</span> shap_vals <span class="kw">in</span> base_shap]</span>
<span id="cb11-589"><a href="#cb11-589" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-590"><a href="#cb11-590" aria-hidden="true" tabindex="-1"></a>                base_model_shap <span class="op">=</span> base_shap[<span class="dv">0</span>, feature_index]</span>
<span id="cb11-591"><a href="#cb11-591" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-592"><a href="#cb11-592" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb11-593"><a href="#cb11-593" aria-hidden="true" tabindex="-1"></a>            <span class="st">'feature'</span>: feature_name,</span>
<span id="cb11-594"><a href="#cb11-594" aria-hidden="true" tabindex="-1"></a>            <span class="st">'combined_influence'</span>: combined_shap,</span>
<span id="cb11-595"><a href="#cb11-595" aria-hidden="true" tabindex="-1"></a>            <span class="st">'influence_paths'</span>: influence_chain,</span>
<span id="cb11-596"><a href="#cb11-596" aria-hidden="true" tabindex="-1"></a>            <span class="st">'base_model'</span>: model_name,</span>
<span id="cb11-597"><a href="#cb11-597" aria-hidden="true" tabindex="-1"></a>            <span class="st">'base_model_shap'</span>: base_model_shap</span>
<span id="cb11-598"><a href="#cb11-598" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-599"><a href="#cb11-599" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-600"><a href="#cb11-600" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_model_influence(<span class="va">self</span>, explanation, model_name):</span>
<span id="cb11-601"><a href="#cb11-601" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb11-602"><a href="#cb11-602" aria-hidden="true" tabindex="-1"></a><span class="co">        Extract the influence of a specific base model to the final prediction</span></span>
<span id="cb11-603"><a href="#cb11-603" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb11-604"><a href="#cb11-604" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb11-605"><a href="#cb11-605" aria-hidden="true" tabindex="-1"></a><span class="co">            explanation (dict): The explanation dict from explain_instance</span></span>
<span id="cb11-606"><a href="#cb11-606" aria-hidden="true" tabindex="-1"></a><span class="co">            model_name (str): Name of the base model to get influence for</span></span>
<span id="cb11-607"><a href="#cb11-607" aria-hidden="true" tabindex="-1"></a><span class="co">            </span></span>
<span id="cb11-608"><a href="#cb11-608" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb11-609"><a href="#cb11-609" aria-hidden="true" tabindex="-1"></a><span class="co">            dict: Dictionary containing influence details</span></span>
<span id="cb11-610"><a href="#cb11-610" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb11-611"><a href="#cb11-611" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if the model exists in the stack model</span></span>
<span id="cb11-612"><a href="#cb11-612" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> model_name <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.stack_model.models:</span>
<span id="cb11-613"><a href="#cb11-613" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Model '</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">' not found in stack model!"</span>)</span>
<span id="cb11-614"><a href="#cb11-614" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb11-615"><a href="#cb11-615" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-616"><a href="#cb11-616" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if the model has SHAP values in the explanation</span></span>
<span id="cb11-617"><a href="#cb11-617" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> model_name <span class="kw">not</span> <span class="kw">in</span> explanation[<span class="st">'base_model_shap'</span>]:</span>
<span id="cb11-618"><a href="#cb11-618" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Model '</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">' not found in explanation's base model SHAP values!"</span>)</span>
<span id="cb11-619"><a href="#cb11-619" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb11-620"><a href="#cb11-620" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-621"><a href="#cb11-621" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get information about this model</span></span>
<span id="cb11-622"><a href="#cb11-622" aria-hidden="true" tabindex="-1"></a>        model_info <span class="op">=</span> <span class="va">self</span>.stack_model.models[model_name]</span>
<span id="cb11-623"><a href="#cb11-623" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> model_info[<span class="st">'features'</span>]</span>
<span id="cb11-624"><a href="#cb11-624" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-625"><a href="#cb11-625" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get SHAP values for this model's features</span></span>
<span id="cb11-626"><a href="#cb11-626" aria-hidden="true" tabindex="-1"></a>        base_shap_info <span class="op">=</span> explanation[<span class="st">'base_model_shap'</span>][model_name]</span>
<span id="cb11-627"><a href="#cb11-627" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-628"><a href="#cb11-628" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get meta-features produced by this model</span></span>
<span id="cb11-629"><a href="#cb11-629" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For classification models, this will be class probabilities</span></span>
<span id="cb11-630"><a href="#cb11-630" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For regression models, this will be predictions</span></span>
<span id="cb11-631"><a href="#cb11-631" aria-hidden="true" tabindex="-1"></a>        model_meta_features <span class="op">=</span> []</span>
<span id="cb11-632"><a href="#cb11-632" aria-hidden="true" tabindex="-1"></a>        meta_feature_indices <span class="op">=</span> []</span>
<span id="cb11-633"><a href="#cb11-633" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-634"><a href="#cb11-634" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find meta-features corresponding to this model in the meta-model</span></span>
<span id="cb11-635"><a href="#cb11-635" aria-hidden="true" tabindex="-1"></a>        meta_idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-636"><a href="#cb11-636" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> m_name, m_info <span class="kw">in</span> <span class="va">self</span>.stack_model.models.items():</span>
<span id="cb11-637"><a href="#cb11-637" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> m_name <span class="op">==</span> model_name:</span>
<span id="cb11-638"><a href="#cb11-638" aria-hidden="true" tabindex="-1"></a>                <span class="co"># If it's our target model, note the indices</span></span>
<span id="cb11-639"><a href="#cb11-639" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> m_info[<span class="st">'model'</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-640"><a href="#cb11-640" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># For models (not direct features), get number of outputs</span></span>
<span id="cb11-641"><a href="#cb11-641" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">hasattr</span>(m_info[<span class="st">'model'</span>], <span class="st">'n_classes_'</span>):</span>
<span id="cb11-642"><a href="#cb11-642" aria-hidden="true" tabindex="-1"></a>                        n_outputs <span class="op">=</span> m_info[<span class="st">'model'</span>].n_classes_</span>
<span id="cb11-643"><a href="#cb11-643" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb11-644"><a href="#cb11-644" aria-hidden="true" tabindex="-1"></a>                        n_outputs <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb11-645"><a href="#cb11-645" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-646"><a href="#cb11-646" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Store meta-feature names and indices</span></span>
<span id="cb11-647"><a href="#cb11-647" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_outputs):</span>
<span id="cb11-648"><a href="#cb11-648" aria-hidden="true" tabindex="-1"></a>                        meta_feat_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_class</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">if</span> n_outputs <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> model_name</span>
<span id="cb11-649"><a href="#cb11-649" aria-hidden="true" tabindex="-1"></a>                        model_meta_features.append(meta_feat_name)</span>
<span id="cb11-650"><a href="#cb11-650" aria-hidden="true" tabindex="-1"></a>                        meta_feature_indices.append(meta_idx <span class="op">+</span> i)</span>
<span id="cb11-651"><a href="#cb11-651" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb11-652"><a href="#cb11-652" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># For direct features, each feature is a meta-feature</span></span>
<span id="cb11-653"><a href="#cb11-653" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> feature <span class="kw">in</span> features:</span>
<span id="cb11-654"><a href="#cb11-654" aria-hidden="true" tabindex="-1"></a>                        model_meta_features.append(feature)</span>
<span id="cb11-655"><a href="#cb11-655" aria-hidden="true" tabindex="-1"></a>                        meta_feature_indices.append(meta_idx)</span>
<span id="cb11-656"><a href="#cb11-656" aria-hidden="true" tabindex="-1"></a>                        meta_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb11-657"><a href="#cb11-657" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb11-658"><a href="#cb11-658" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-659"><a href="#cb11-659" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update meta-feature index based on previous models</span></span>
<span id="cb11-660"><a href="#cb11-660" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> m_info[<span class="st">'model'</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-661"><a href="#cb11-661" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">hasattr</span>(m_info[<span class="st">'model'</span>], <span class="st">'n_classes_'</span>):</span>
<span id="cb11-662"><a href="#cb11-662" aria-hidden="true" tabindex="-1"></a>                        meta_idx <span class="op">+=</span> m_info[<span class="st">'model'</span>].n_classes_</span>
<span id="cb11-663"><a href="#cb11-663" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb11-664"><a href="#cb11-664" aria-hidden="true" tabindex="-1"></a>                        meta_idx <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb11-665"><a href="#cb11-665" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb11-666"><a href="#cb11-666" aria-hidden="true" tabindex="-1"></a>                    meta_idx <span class="op">+=</span> <span class="bu">len</span>(m_info[<span class="st">'features'</span>])</span>
<span id="cb11-667"><a href="#cb11-667" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-668"><a href="#cb11-668" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get meta-model SHAP values for this model's outputs</span></span>
<span id="cb11-669"><a href="#cb11-669" aria-hidden="true" tabindex="-1"></a>        meta_shap <span class="op">=</span> explanation[<span class="st">'meta_model_shap'</span>]</span>
<span id="cb11-670"><a href="#cb11-670" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-671"><a href="#cb11-671" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle multi-class meta models</span></span>
<span id="cb11-672"><a href="#cb11-672" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(meta_shap, <span class="bu">list</span>):</span>
<span id="cb11-673"><a href="#cb11-673" aria-hidden="true" tabindex="-1"></a>            meta_model_shap <span class="op">=</span> []</span>
<span id="cb11-674"><a href="#cb11-674" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> class_shap <span class="kw">in</span> meta_shap:</span>
<span id="cb11-675"><a href="#cb11-675" aria-hidden="true" tabindex="-1"></a>                meta_model_shap.append([class_shap[<span class="dv">0</span>, idx] <span class="cf">for</span> idx <span class="kw">in</span> meta_feature_indices])</span>
<span id="cb11-676"><a href="#cb11-676" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-677"><a href="#cb11-677" aria-hidden="true" tabindex="-1"></a>            meta_model_shap <span class="op">=</span> [meta_shap[<span class="dv">0</span>, idx] <span class="cf">for</span> idx <span class="kw">in</span> meta_feature_indices]</span>
<span id="cb11-678"><a href="#cb11-678" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-679"><a href="#cb11-679" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate total influence of this model on final prediction</span></span>
<span id="cb11-680"><a href="#cb11-680" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sum of all meta-feature SHAP values corresponding to this model</span></span>
<span id="cb11-681"><a href="#cb11-681" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(meta_model_shap[<span class="dv">0</span>], <span class="bu">list</span>):</span>
<span id="cb11-682"><a href="#cb11-682" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For multi-class meta models</span></span>
<span id="cb11-683"><a href="#cb11-683" aria-hidden="true" tabindex="-1"></a>            total_influence <span class="op">=</span> [<span class="bu">sum</span>(class_shap) <span class="cf">for</span> class_shap <span class="kw">in</span> meta_model_shap]</span>
<span id="cb11-684"><a href="#cb11-684" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-685"><a href="#cb11-685" aria-hidden="true" tabindex="-1"></a>            total_influence <span class="op">=</span> <span class="bu">sum</span>(meta_model_shap)</span>
<span id="cb11-686"><a href="#cb11-686" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-687"><a href="#cb11-687" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get influence of each feature in this model</span></span>
<span id="cb11-688"><a href="#cb11-688" aria-hidden="true" tabindex="-1"></a>        feature_influences <span class="op">=</span> {}</span>
<span id="cb11-689"><a href="#cb11-689" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> feature <span class="kw">in</span> features:</span>
<span id="cb11-690"><a href="#cb11-690" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Try to find this feature in the combined SHAP values</span></span>
<span id="cb11-691"><a href="#cb11-691" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> feature <span class="kw">in</span> explanation[<span class="st">'combined_shap'</span>]:</span>
<span id="cb11-692"><a href="#cb11-692" aria-hidden="true" tabindex="-1"></a>                feature_influences[feature] <span class="op">=</span> explanation[<span class="st">'combined_shap'</span>][feature]</span>
<span id="cb11-693"><a href="#cb11-693" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-694"><a href="#cb11-694" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb11-695"><a href="#cb11-695" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>: model_name,</span>
<span id="cb11-696"><a href="#cb11-696" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_influence'</span>: total_influence,</span>
<span id="cb11-697"><a href="#cb11-697" aria-hidden="true" tabindex="-1"></a>            <span class="st">'meta_features'</span>: <span class="bu">dict</span>(<span class="bu">zip</span>(model_meta_features, meta_model_shap)),</span>
<span id="cb11-698"><a href="#cb11-698" aria-hidden="true" tabindex="-1"></a>            <span class="st">'features'</span>: features,</span>
<span id="cb11-699"><a href="#cb11-699" aria-hidden="true" tabindex="-1"></a>            <span class="st">'feature_influences'</span>: feature_influences,</span>
<span id="cb11-700"><a href="#cb11-700" aria-hidden="true" tabindex="-1"></a>            <span class="st">'base_model_shap_values'</span>: base_shap_info[<span class="st">'shap_values'</span>]</span>
<span id="cb11-701"><a href="#cb11-701" aria-hidden="true" tabindex="-1"></a>        }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This verification code includes two key functions designed to validate and debug the SHAP explanations produced by the StackModelShapExplainer:</p>
<section id="verify_chain_rule_calculation-function" class="level3">
<h3 class="anchored" data-anchor-id="verify_chain_rule_calculation-function"><code>verify_chain_rule_calculation</code> Function</h3>
<p>This function validates whether the chain rule calculations in the explainer are correct for a specific feature. It:</p>
<ol type="1">
<li><p><strong>Identifies which model contains the feature</strong> - It searches through the stack model to determine which base model uses the specified feature.</p></li>
<li><p><strong>Extracts base model SHAP values</strong> - It retrieves the SHAP values for this feature from the base model, handling both classification and regression cases.</p></li>
<li><p><strong>Examines meta-model SHAP values</strong> - It identifies the meta-features that are influenced by this feature and retrieves their SHAP values.</p></li>
<li><p><strong>Validates chain rule calculations</strong> - It compares the sum of influence paths (from the feature influence chain) with the combined SHAP value to verify mathematical consistency.</p></li>
<li><p><strong>Handles pass-through features</strong> - For features that bypass base models and go directly to the meta-model, it performs a different validation.</p></li>
</ol>
<p>The function provides detailed logging at each step, showing the mathematical components that should add up to the final combined SHAP value. It concludes with a pass/fail indicator showing whether the chain rule calculation is correct (✓) or has a discrepancy (✗).</p>
</section>
<section id="print_detailed_shap_values-function" class="level3">
<h3 class="anchored" data-anchor-id="print_detailed_shap_values-function"><code>print_detailed_shap_values</code> Function</h3>
<p>This function prints a comprehensive breakdown of all SHAP values at each level of the stack model:</p>
<ol type="1">
<li><p><strong>Original feature SHAP values</strong> - Lists the combined influence of each original feature.</p></li>
<li><p><strong>Base model SHAP values</strong> - For each base model, it shows how input features influence that model’s output, handling multi-class cases appropriately.</p></li>
<li><p><strong>Meta-feature values</strong> - Shows the actual values of the meta-features (outputs from base models) that feed into the meta-model.</p></li>
<li><p><strong>Meta-model SHAP values</strong> - Details how each meta-feature influences the final prediction.</p></li>
<li><p><strong>Chain rule calculations</strong> - For each original feature, it shows how its influence propagates through different meta-features, culminating in its combined effect.</p></li>
</ol>
<p>These functions are valuable debugging and verification tools that:</p>
<ol type="1">
<li>Ensure the mathematical correctness of the combined SHAP value calculations</li>
<li>Help users understand the flow of influence through the model stack</li>
<li>Validate that the chain rule implementation properly accounts for all paths of influence</li>
<li>Provide transparency into how feature attributions are derived</li>
</ol>
<p>They would typically be used during development of the explainer or when users want to deeply understand or verify the explanations for particularly important predictions.</p>
<div id="3573399f" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> verify_chain_rule_calculation(explanation, stack_model, feature_name, target_class<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Verify the chain rule calculation for a specific feature</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">        explanation (dict): The explanation dict from explain_instance</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">        stack_model (StackModel): The trained stacking model</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">        feature_name (str): Name of the feature to verify</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">        target_class (int, optional): Class to focus on for multi-class problems</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">===== VERIFYING CHAIN RULE FOR FEATURE: </span><span class="sc">{</span>feature_name<span class="sc">}</span><span class="ss"> =====</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find which model contains this feature</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    model_name <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    feature_index <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> m_name, model_info <span class="kw">in</span> stack_model.models.items():</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> feature_name <span class="kw">in</span> model_info[<span class="st">'features'</span>]:</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>            model_name <span class="op">=</span> m_name</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>            feature_index <span class="op">=</span> model_info[<span class="st">'features'</span>].index(feature_name)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model_name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Feature </span><span class="sc">{</span>feature_name<span class="sc">}</span><span class="ss"> not found in any model!"</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Feature </span><span class="sc">{</span>feature_name<span class="sc">}</span><span class="ss"> belongs to model </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> at index </span><span class="sc">{</span>feature_index<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get base model SHAP values for this feature</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stack_model.models[model_name][<span class="st">'model'</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>        base_shap <span class="op">=</span> explanation[<span class="st">'base_model_shap'</span>][model_name][<span class="st">'shap_values'</span>]</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(base_shap, <span class="bu">list</span>) <span class="kw">and</span> target_class <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>            base_feature_shap <span class="op">=</span> base_shap[target_class][<span class="dv">0</span>, feature_index]</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Base model SHAP value (class </span><span class="sc">{</span>target_class<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>base_feature_shap<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(base_shap, <span class="bu">list</span>):</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> class_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(base_shap)):</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>                base_feature_shap <span class="op">=</span> base_shap[class_idx][<span class="dv">0</span>, feature_index]</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Base model SHAP value (class </span><span class="sc">{</span>class_idx<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>base_feature_shap<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>            base_feature_shap <span class="op">=</span> base_shap[<span class="dv">0</span>, feature_index]</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Base model SHAP value: </span><span class="sc">{</span>base_feature_shap<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get meta-model SHAP values for outputs of this model</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        meta_shap <span class="op">=</span> explanation[<span class="st">'meta_model_shap'</span>]</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        meta_feature_names <span class="op">=</span> stack_model.feature_name_</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        meta_indices <span class="op">=</span> [i <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(meta_feature_names) <span class="cf">if</span> name.startswith(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_class"</span>)]</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Meta-model SHAP values for this model's outputs:"</span>)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(meta_shap, <span class="bu">list</span>) <span class="kw">and</span> target_class <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> idx <span class="kw">in</span> meta_indices:</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>                meta_feat_name <span class="op">=</span> meta_feature_names[idx]</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>                meta_feat_shap <span class="op">=</span> meta_shap[target_class][<span class="dv">0</span>, idx]</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>meta_feat_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>meta_feat_shap<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(meta_shap, <span class="bu">list</span>):</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> class_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(meta_shap)):</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> idx <span class="kw">in</span> meta_indices:</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>                    meta_feat_name <span class="op">=</span> meta_feature_names[idx]</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>                    meta_feat_shap <span class="op">=</span> meta_shap[class_idx][<span class="dv">0</span>, idx]</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>meta_feat_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>meta_feat_shap<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> idx <span class="kw">in</span> meta_indices:</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>                meta_feat_name <span class="op">=</span> meta_feature_names[idx]</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>                meta_feat_shap <span class="op">=</span> meta_shap[<span class="dv">0</span>, idx]</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>meta_feat_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>meta_feat_shap<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verify chain rule calculation</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Chain rule calculation:"</span>)</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>        combined_effect <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> meta_feature, value <span class="kw">in</span> explanation[<span class="st">'feature_influence_chain'</span>][feature_name].items():</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>meta_feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>            combined_effect <span class="op">+=</span> value</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Sum of all paths: </span><span class="sc">{</span>combined_effect<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Combined SHAP value: </span><span class="sc">{</span>explanation[<span class="st">'combined_shap'</span>][feature_name]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">abs</span>(combined_effect <span class="op">-</span> explanation[<span class="st">'combined_shap'</span>][feature_name]) <span class="op">&lt;</span> <span class="fl">1e-6</span>:</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"✓ Chain rule calculation is correct!"</span>)</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"✗ Chain rule calculation has discrepancy!"</span>)</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For pass-through features</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>        meta_shap <span class="op">=</span> explanation[<span class="st">'meta_model_shap'</span>]</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>        meta_feature_names <span class="op">=</span> stack_model.feature_name_</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>        meta_idx <span class="op">=</span> meta_feature_names.index(feature_name)</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"This is a pass-through feature, so SHAP value comes directly from meta-model."</span>)</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(meta_shap, <span class="bu">list</span>) <span class="kw">and</span> target_class <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>            meta_shap_val <span class="op">=</span> meta_shap[target_class][<span class="dv">0</span>, meta_idx]</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Meta-model SHAP value (class </span><span class="sc">{</span>target_class<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>meta_shap_val<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(meta_shap, <span class="bu">list</span>):</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> class_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(meta_shap)):</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>                meta_shap_val <span class="op">=</span> meta_shap[class_idx][<span class="dv">0</span>, meta_idx]</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Meta-model SHAP value (class </span><span class="sc">{</span>class_idx<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>meta_shap_val<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>            meta_shap_val <span class="op">=</span> meta_shap[<span class="dv">0</span>, meta_idx]</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Meta-model SHAP value: </span><span class="sc">{</span>meta_shap_val<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if calculation is correct</span></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">abs</span>(meta_shap_val <span class="op">-</span> explanation[<span class="st">'combined_shap'</span>][feature_name]) <span class="op">&lt;</span> <span class="fl">1e-6</span>:</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"✓ Direct pass-through SHAP value is correct!"</span>)</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"✗ Direct pass-through SHAP value has discrepancy!"</span>)</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_detailed_shap_values(explanation, stack_model, target_class<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a><span class="co">    Print detailed SHAP values for both base models and meta-model.</span></span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a><span class="co">        explanation (dict): The explanation dict from explain_instance.</span></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a><span class="co">        stack_model (StackModel): The trained stacking model.</span></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a><span class="co">        target_class (int, optional): Class to focus on for multi-class problems.</span></span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== DETAILED SHAP VALUES =====</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get original features</span></span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>    orig_features <span class="op">=</span> []</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> model_name, model_info <span class="kw">in</span> stack_model.models.items():</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>        orig_features.extend(model_info[<span class="st">'features'</span>])</span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print SHAP values for original features</span></span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature <span class="kw">in</span> orig_features:</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> feature <span class="kw">in</span> explanation[<span class="st">'combined_shap'</span>]:</span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>explanation[<span class="st">'combined_shap'</span>][feature]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">BASE MODELS SHAP VALUES:"</span>)</span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> model_name, shap_info <span class="kw">in</span> explanation[<span class="st">'base_model_shap'</span>].items():</span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Model: </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> shap_info[<span class="st">'feature_names'</span>]</span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a>        shap_values <span class="op">=</span> shap_info[<span class="st">'shap_values'</span>]</span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle multi-class SHAP values</span></span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(shap_values, <span class="bu">list</span>) <span class="kw">and</span> target_class <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"    Class </span><span class="sc">{</span>target_class<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, feature <span class="kw">in</span> <span class="bu">enumerate</span>(features):</span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"      </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>shap_values[target_class][<span class="dv">0</span>, i]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(shap_values, <span class="bu">list</span>):</span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> class_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(shap_values)):</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"    Class </span><span class="sc">{</span>class_idx<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> i, feature <span class="kw">in</span> <span class="bu">enumerate</span>(features):</span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"      </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>shap_values[class_idx][<span class="dv">0</span>, i]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, feature <span class="kw">in</span> <span class="bu">enumerate</span>(features):</span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>shap_values[<span class="dv">0</span>, i]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if feature names are None before proceeding</span></span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a>    meta_feature_names <span class="op">=</span> stack_model.feature_name_</span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> meta_feature_names <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Error: meta_feature_names is None. Please check if the stacking model has been properly fitted."</span>)</span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">META-FEATURES VALUES:"</span>)</span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>    meta_features <span class="op">=</span> explanation[<span class="st">'meta_features'</span>][<span class="dv">0</span>]</span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(meta_feature_names):</span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>meta_features[i]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">META-MODEL SHAP VALUES:"</span>)</span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>    meta_shap <span class="op">=</span> explanation[<span class="st">'meta_model_shap'</span>]</span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(meta_shap, <span class="bu">list</span>) <span class="kw">and</span> target_class <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Class </span><span class="sc">{</span>target_class<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(meta_feature_names):</span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>meta_shap[target_class][<span class="dv">0</span>, i]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(meta_shap, <span class="bu">list</span>):</span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> class_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(meta_shap)):</span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Class </span><span class="sc">{</span>class_idx<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(meta_feature_names):</span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>meta_shap[class_idx][<span class="dv">0</span>, i]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(meta_feature_names):</span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>meta_shap[<span class="dv">0</span>, i]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">CHAIN RULE CALCULATIONS:"</span>)</span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, influences <span class="kw">in</span> explanation[<span class="st">'feature_influence_chain'</span>].items():</span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Feature: </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> meta_feature, value <span class="kw">in</span> influences.items():</span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"    via </span><span class="sc">{</span>meta_feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    Combined effect: </span><span class="sc">{</span>explanation[<span class="st">'combined_shap'</span>][feature]<span class="sc">:.6f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7d613670" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, classification_report</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> wine_quality_stacking_example(save_plots<span class="op">=</span><span class="va">True</span>, output_dir<span class="op">=</span><span class="st">'outputs'</span>):</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">    End-to-end example of using StackModelShapExplainer with a wine quality dataset.</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">        save_plots (bool): Whether to save plots to disk instead of displaying</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">        output_dir (str): Directory to save plots and results</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">        tuple: (stack_model, explainer, X_test, y_test, label_encoder, explanation)</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Wine Quality Stacking Model Example with SHAP Explanations"</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create output directory if needed</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_plots <span class="kw">and</span> <span class="kw">not</span> os.path.exists(output_dir):</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        os.makedirs(output_dir)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate synthetic wine quality data</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    n_samples <span class="op">=</span> <span class="dv">1599</span>  <span class="co"># Similar to the real wine quality dataset size</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feature names for wine quality dataset</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> [<span class="st">'fixed acidity'</span>, <span class="st">'volatile acidity'</span>, <span class="st">'citric acid'</span>, <span class="st">'residual sugar'</span>,</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>               <span class="st">'chlorides'</span>, <span class="st">'free sulfur dioxide'</span>, <span class="st">'total sulfur dioxide'</span>, <span class="st">'density'</span>,</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>               <span class="st">'pH'</span>, <span class="st">'sulphates'</span>, <span class="st">'alcohol'</span>]</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate synthetic data with realistic distributions</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    wine_data <span class="op">=</span> {</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fixed acidity'</span>: np.random.normal(<span class="fl">7.2</span>, <span class="fl">1.3</span>, n_samples),</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'volatile acidity'</span>: np.random.normal(<span class="fl">0.34</span>, <span class="fl">0.17</span>, n_samples),</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'citric acid'</span>: np.random.normal(<span class="fl">0.32</span>, <span class="fl">0.14</span>, n_samples),</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'residual sugar'</span>: np.clip(np.random.exponential(<span class="fl">2.0</span>, n_samples), <span class="fl">0.9</span>, <span class="fl">15.5</span>),</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'chlorides'</span>: np.clip(np.random.exponential(<span class="fl">0.05</span>, n_samples), <span class="fl">0.01</span>, <span class="fl">0.6</span>),</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">'free sulfur dioxide'</span>: np.clip(np.random.normal(<span class="dv">30</span>, <span class="dv">17</span>, n_samples), <span class="dv">1</span>, <span class="dv">120</span>),</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total sulfur dioxide'</span>: np.clip(np.random.normal(<span class="dv">115</span>, <span class="dv">56</span>, n_samples), <span class="dv">6</span>, <span class="dv">300</span>),</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'density'</span>: np.random.normal(<span class="fl">0.995</span>, <span class="fl">0.002</span>, n_samples),</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'pH'</span>: np.random.normal(<span class="fl">3.2</span>, <span class="fl">0.16</span>, n_samples),</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sulphates'</span>: np.random.normal(<span class="fl">0.53</span>, <span class="fl">0.15</span>, n_samples),</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'alcohol'</span>: np.clip(np.random.normal(<span class="fl">10.4</span>, <span class="fl">1.1</span>, n_samples), <span class="fl">8.0</span>, <span class="fl">14.0</span>),</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate quality based on feature values to make it more realistic</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Wine quality is higher with higher alcohol, lower volatile acidity, etc.</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    quality <span class="op">=</span> <span class="dv">6</span> <span class="op">+</span> (wine_data[<span class="st">'alcohol'</span>] <span class="op">-</span> <span class="fl">10.4</span>) <span class="op">/</span> <span class="fl">1.1</span> <span class="op">-</span> (wine_data[<span class="st">'volatile acidity'</span>] <span class="op">-</span> <span class="fl">0.34</span>) <span class="op">/</span> <span class="fl">0.17</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    quality <span class="op">=</span> np.<span class="bu">round</span>(np.clip(quality, <span class="dv">3</span>, <span class="dv">8</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>    wine_data[<span class="st">'quality'</span>] <span class="op">=</span> quality</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create DataFrame</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pd.DataFrame(wine_data)</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert target to multi-class (low, medium, high quality)</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Converting wine quality to categorical labels..."</span>)</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> quality_label(q):</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> q <span class="op">&lt;=</span> <span class="dv">5</span>:</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'low'</span></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> q <span class="op">==</span> <span class="dv">6</span>:</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'medium'</span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'high'</span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'quality_label'</span>] <span class="op">=</span> data[<span class="st">'quality'</span>].<span class="bu">apply</span>(quality_label)</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>    data.drop(columns<span class="op">=</span>[<span class="st">'quality'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display class distribution</span></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>    class_counts <span class="op">=</span> data[<span class="st">'quality_label'</span>].value_counts()</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Class distribution:"</span>)</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(class_counts)</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Encode target labels</span></span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>    label_encoder <span class="op">=</span> LabelEncoder()</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'quality_label'</span>] <span class="op">=</span> label_encoder.fit_transform(data[<span class="st">'quality_label'</span>])</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Encoded classes: </span><span class="sc">{</span><span class="bu">dict</span>(<span class="bu">zip</span>(label_encoder.classes_, label_encoder.transform(label_encoder.classes_)))<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Features and target</span></span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> data.drop(columns<span class="op">=</span>[<span class="st">'quality_label'</span>])</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> data[<span class="st">'quality_label'</span>]</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split data</span></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Splitting data into train and test sets..."</span>)</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>    X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y)</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Training set size: </span><span class="sc">{</span>X_train<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">, Test set size: </span><span class="sc">{</span>X_test<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define model configuration</span></span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Configuring stacked model architecture..."</span>)</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>    model_configs <span class="op">=</span> {</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>        <span class="st">'acidity_model'</span>: {</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>            <span class="st">'feature_names'</span>: [<span class="st">'fixed acidity'</span>, <span class="st">'volatile acidity'</span>, <span class="st">'citric acid'</span>, <span class="st">'pH'</span>],</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">'estimators'</span>: lgb.LGBMClassifier,</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>            <span class="st">'hyperparameters'</span>: {<span class="st">'n_estimators'</span>: <span class="dv">100</span>, <span class="st">'max_depth'</span>: <span class="dv">3</span>, <span class="st">'verbosity'</span>: <span class="op">-</span><span class="dv">1</span>}</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>        <span class="st">'chemical_model'</span>: {</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>            <span class="st">'feature_names'</span>: [<span class="st">'chlorides'</span>, <span class="st">'free sulfur dioxide'</span>, <span class="st">'total sulfur dioxide'</span>, <span class="st">'sulphates'</span>],</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>            <span class="st">'estimators'</span>: lgb.LGBMClassifier,</span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>            <span class="st">'hyperparameters'</span>: {<span class="st">'n_estimators'</span>: <span class="dv">100</span>, <span class="st">'max_depth'</span>: <span class="dv">4</span>, <span class="st">'verbosity'</span>: <span class="op">-</span><span class="dv">1</span>}</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>        <span class="st">'physical_properties'</span>: {</span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>            <span class="st">'feature_names'</span>: [<span class="st">'residual sugar'</span>, <span class="st">'density'</span>, <span class="st">'alcohol'</span>],</span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>            <span class="st">'estimators'</span>: lgb.LGBMClassifier,</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>            <span class="st">'hyperparameters'</span>: {<span class="st">'n_estimators'</span>: <span class="dv">100</span>, <span class="st">'max_depth'</span>: <span class="dv">3</span>, <span class="st">'verbosity'</span>: <span class="op">-</span><span class="dv">1</span>}</span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create and train the stacking model</span></span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Training stacked model..."</span>)</span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>    final_estimator <span class="op">=</span> lgb.LGBMClassifier(n_estimators<span class="op">=</span><span class="dv">50</span>, verbosity<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>    stack_model <span class="op">=</span> StackModel(model_configs, final_estimator, cv<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>    stack_model.fit(X_train, y_train)</span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate model</span></span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Evaluating model performance..."</span>)</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> stack_model.predict(X_test)</span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> accuracy_score(y_test, y_pred)</span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Stacking Model Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Classification Report:"</span>)</span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(classification_report(y_test, y_pred, target_names<span class="op">=</span>label_encoder.classes_))</span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create SHAP explainer</span></span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Creating SHAP explainer..."</span>)</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a>    explainer <span class="op">=</span> StackModelShapExplainer(stack_model, background_data<span class="op">=</span>X_train, n_background<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get explanation for a single instance</span></span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>    instance_idx <span class="op">=</span> <span class="dv">25</span></span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a>    instance <span class="op">=</span> X_test.iloc[[instance_idx]]</span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a>    true_class <span class="op">=</span> y_test.iloc[instance_idx]</span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a>    class_name <span class="op">=</span> label_encoder.inverse_transform([true_class])[<span class="dv">0</span>]</span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Explaining prediction for instance with true class: </span><span class="sc">{</span>class_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display feature values for selected instance</span></span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Feature values for the explained instance:"</span>)</span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature <span class="kw">in</span> X.columns:</span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>instance[feature]<span class="sc">.</span>values[<span class="dv">0</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get explanation for the instance</span></span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Generating SHAP explanation..."</span>)</span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>    explanation <span class="op">=</span> explainer.explain_instance(instance, target_class<span class="op">=</span>true_class)</span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print combined SHAP values</span></span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Top 5 combined SHAP values (impact on final prediction):"</span>)</span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, value <span class="kw">in</span> <span class="bu">sorted</span>(explanation[<span class="st">'combined_shap'</span>].items(), </span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a>                               key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">abs</span>(x[<span class="dv">1</span>]), reverse<span class="op">=</span><span class="va">True</span>)[:<span class="dv">5</span>]:</span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot feature importance for the dataset</span></span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Plotting overall feature importance..."</span>)</span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a>    fig_importance <span class="op">=</span> explainer.plot_feature_importance(</span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a>        X_test, </span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a>        target_class<span class="op">=</span><span class="dv">1</span></span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plt.title(f"Feature Importance for Class: {class_name}")</span></span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_plots:</span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a>        plt.savefig(os.path.join(output_dir, <span class="st">'feature_importance.png'</span>), dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualize prediction path</span></span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Visualizing prediction path..."</span>)</span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a>        fig_path <span class="op">=</span> explainer.visualize_prediction_path(</span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a>            instance, </span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a>            target_class<span class="op">=</span>true_class</span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> save_plots:</span>
<span id="cb13-175"><a href="#cb13-175" aria-hidden="true" tabindex="-1"></a>            plt.savefig(os.path.join(output_dir, <span class="st">'prediction_path.png'</span>), dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb13-176"><a href="#cb13-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a>            plt.show()</span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error visualizing prediction path: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-180"><a href="#cb13-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-181"><a href="#cb13-181" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create waterfall plot</span></span>
<span id="cb13-182"><a href="#cb13-182" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Creating waterfall plot..."</span>)</span>
<span id="cb13-183"><a href="#cb13-183" aria-hidden="true" tabindex="-1"></a>    fig_waterfall, ax_waterfall <span class="op">=</span> explainer.plot_waterfall(</span>
<span id="cb13-184"><a href="#cb13-184" aria-hidden="true" tabindex="-1"></a>        instance, </span>
<span id="cb13-185"><a href="#cb13-185" aria-hidden="true" tabindex="-1"></a>        target_class<span class="op">=</span>true_class,</span>
<span id="cb13-186"><a href="#cb13-186" aria-hidden="true" tabindex="-1"></a>        max_features<span class="op">=</span><span class="dv">10</span></span>
<span id="cb13-187"><a href="#cb13-187" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-188"><a href="#cb13-188" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"Feature Contributions for Class: </span><span class="sc">{</span>class_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-189"><a href="#cb13-189" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-190"><a href="#cb13-190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_plots:</span>
<span id="cb13-191"><a href="#cb13-191" aria-hidden="true" tabindex="-1"></a>        plt.savefig(os.path.join(output_dir, <span class="st">'waterfall_plot.png'</span>), dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb13-192"><a href="#cb13-192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-193"><a href="#cb13-193" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb13-194"><a href="#cb13-194" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-195"><a href="#cb13-195" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print detailed SHAP values</span></span>
<span id="cb13-196"><a href="#cb13-196" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Printing detailed SHAP values..."</span>)</span>
<span id="cb13-197"><a href="#cb13-197" aria-hidden="true" tabindex="-1"></a>    print_detailed_shap_values(explanation, stack_model, target_class<span class="op">=</span>true_class)</span>
<span id="cb13-198"><a href="#cb13-198" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-199"><a href="#cb13-199" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify chain rule calculation for top features</span></span>
<span id="cb13-200"><a href="#cb13-200" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Verifying chain rule calculations..."</span>)</span>
<span id="cb13-201"><a href="#cb13-201" aria-hidden="true" tabindex="-1"></a>    important_features <span class="op">=</span> [x[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">sorted</span>(</span>
<span id="cb13-202"><a href="#cb13-202" aria-hidden="true" tabindex="-1"></a>        explanation[<span class="st">'combined_shap'</span>].items(), key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">abs</span>(x[<span class="dv">1</span>]), reverse<span class="op">=</span><span class="va">True</span></span>
<span id="cb13-203"><a href="#cb13-203" aria-hidden="true" tabindex="-1"></a>    )[:<span class="dv">3</span>]]</span>
<span id="cb13-204"><a href="#cb13-204" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-205"><a href="#cb13-205" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature <span class="kw">in</span> important_features:</span>
<span id="cb13-206"><a href="#cb13-206" aria-hidden="true" tabindex="-1"></a>        verify_chain_rule_calculation(explanation, stack_model, feature, target_class<span class="op">=</span>true_class)</span>
<span id="cb13-207"><a href="#cb13-207" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-208"><a href="#cb13-208" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feature influence analysis</span></span>
<span id="cb13-209"><a href="#cb13-209" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Analyzing feature influence paths..."</span>)</span>
<span id="cb13-210"><a href="#cb13-210" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature <span class="kw">in</span> important_features:</span>
<span id="cb13-211"><a href="#cb13-211" aria-hidden="true" tabindex="-1"></a>        influence <span class="op">=</span> explainer.get_feature_influence(explanation, feature)</span>
<span id="cb13-212"><a href="#cb13-212" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Feature: </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-213"><a href="#cb13-213" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Total influence: </span><span class="sc">{</span>influence[<span class="st">'combined_influence'</span>]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb13-214"><a href="#cb13-214" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Influence paths:"</span>)</span>
<span id="cb13-215"><a href="#cb13-215" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> meta_feature, value <span class="kw">in</span> <span class="bu">sorted</span>(influence[<span class="st">'influence_paths'</span>].items(), </span>
<span id="cb13-216"><a href="#cb13-216" aria-hidden="true" tabindex="-1"></a>                                         key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">abs</span>(x[<span class="dv">1</span>]), reverse<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb13-217"><a href="#cb13-217" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Via </span><span class="sc">{</span>meta_feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb13-218"><a href="#cb13-218" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-219"><a href="#cb13-219" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model influence analysis</span></span>
<span id="cb13-220"><a href="#cb13-220" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Analyzing model contributions..."</span>)</span>
<span id="cb13-221"><a href="#cb13-221" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> model_name <span class="kw">in</span> model_configs.keys():</span>
<span id="cb13-222"><a href="#cb13-222" aria-hidden="true" tabindex="-1"></a>        model_influence <span class="op">=</span> explainer.get_model_influence(explanation, model_name)</span>
<span id="cb13-223"><a href="#cb13-223" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Model: </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-224"><a href="#cb13-224" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Total influence: </span><span class="sc">{</span>model_influence[<span class="st">'total_influence'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-225"><a href="#cb13-225" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Influence through meta-features:"</span>)</span>
<span id="cb13-226"><a href="#cb13-226" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> meta_feature, value <span class="kw">in</span> model_influence[<span class="st">'meta_features'</span>].items():</span>
<span id="cb13-227"><a href="#cb13-227" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Via </span><span class="sc">{</span>meta_feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-228"><a href="#cb13-228" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-229"><a href="#cb13-229" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Example completed successfully!"</span>)</span>
<span id="cb13-230"><a href="#cb13-230" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stack_model, explainer, X_test, y_test, label_encoder, explanation</span>
<span id="cb13-231"><a href="#cb13-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-232"><a href="#cb13-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-233"><a href="#cb13-233" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb13-234"><a href="#cb13-234" aria-hidden="true" tabindex="-1"></a>    stack_model, explainer, X_test, y_test, label_encoder, explanation <span class="op">=</span> wine_quality_stacking_example()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
Wine Quality Stacking Model Example with SHAP Explanations
================================================================================

Converting wine quality to categorical labels...
Class distribution:
quality_label
high      576
low       548
medium    475
Name: count, dtype: int64
Encoded classes: {'high': 0, 'low': 1, 'medium': 2}

Splitting data into train and test sets...
Training set size: 1279, Test set size: 320

Configuring stacked model architecture...

Training stacked model...

Evaluating model performance...
Stacking Model Accuracy: 0.8187

Classification Report:
              precision    recall  f1-score   support

        high       0.87      0.88      0.87       115
         low       0.86      0.87      0.87       110
      medium       0.70      0.68      0.69        95

    accuracy                           0.82       320
   macro avg       0.81      0.81      0.81       320
weighted avg       0.82      0.82      0.82       320


Creating SHAP explainer...

Explaining prediction for instance with true class: medium

Feature values for the explained instance:
fixed acidity: 6.1331
volatile acidity: 0.3528
citric acid: 0.0838
residual sugar: 0.9000
chlorides: 0.0420
free sulfur dioxide: 26.1666
total sulfur dioxide: 20.7110
density: 0.9939
pH: 3.2429
sulphates: 0.1829
alcohol: 10.1959

Generating SHAP explanation...

Top 5 combined SHAP values (impact on final prediction):
alcohol: 0.179514
volatile acidity: 0.079854
fixed acidity: -0.061502
density: -0.050285
citric acid: -0.036569

Plotting overall feature importance...</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="StackModelShapExplainer_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Visualizing prediction path...</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 640x480 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="StackModelShapExplainer_files/figure-html/cell-5-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Creating waterfall plot...

Printing detailed SHAP values...

===== DETAILED SHAP VALUES =====

  fixed acidity: -0.061502
  volatile acidity: 0.079854
  citric acid: -0.036569
  pH: -0.024314
  chlorides: -0.004809
  free sulfur dioxide: -0.017936
  total sulfur dioxide: 0.008719
  sulphates: -0.002468
  residual sugar: 0.007396
  density: -0.050285
  alcohol: 0.179514

BASE MODELS SHAP VALUES:
  Model: acidity_model
    fixed acidity: -0.079397
    volatile acidity: 0.103088
    citric acid: -0.047208
    pH: -0.031388
  Model: chemical_model
    chlorides: 0.074946
    free sulfur dioxide: 0.279515
    total sulfur dioxide: -0.135886
    sulphates: 0.038459
  Model: physical_properties
    residual sugar: 0.014496
    density: -0.098555
    alcohol: 0.351834

META-FEATURES VALUES:
  acidity_model_class0: 0.227219
  acidity_model_class1: 0.474671
  acidity_model_class2: 0.298110
  chemical_model_class0: 0.459772
  chemical_model_class1: 0.197444
  chemical_model_class2: 0.342784
  physical_properties_class0: 0.307260
  physical_properties_class1: 0.338261
  physical_properties_class2: 0.354479

META-MODEL SHAP VALUES:
  acidity_model_class0: 0.263017
  acidity_model_class1: 0.287869
  acidity_model_class2: 0.223734
  chemical_model_class0: -0.082719
  chemical_model_class1: 0.209395
  chemical_model_class2: -0.190844
  physical_properties_class0: 0.514815
  physical_properties_class1: 0.251906
  physical_properties_class2: -0.256497

CHAIN RULE CALCULATIONS:
  Feature: fixed acidity
    via acidity_model_class0: -0.020883
    via acidity_model_class1: -0.022856
    via acidity_model_class2: -0.017764
    Combined effect: -0.061502
  Feature: volatile acidity
    via acidity_model_class0: 0.027114
    via acidity_model_class1: 0.029676
    via acidity_model_class2: 0.023064
    Combined effect: 0.079854
  Feature: citric acid
    via acidity_model_class0: -0.012417
    via acidity_model_class1: -0.013590
    via acidity_model_class2: -0.010562
    Combined effect: -0.036569
  Feature: pH
    via acidity_model_class0: -0.008255
    via acidity_model_class1: -0.009036
    via acidity_model_class2: -0.007022
    Combined effect: -0.024314
  Feature: chlorides
    via chemical_model_class0: -0.006199
    via chemical_model_class1: 0.015693
    via chemical_model_class2: -0.014303
    Combined effect: -0.004809
  Feature: free sulfur dioxide
    via chemical_model_class0: -0.023121
    via chemical_model_class1: 0.058529
    via chemical_model_class2: -0.053344
    Combined effect: -0.017936
  Feature: total sulfur dioxide
    via chemical_model_class0: 0.011240
    via chemical_model_class1: -0.028454
    via chemical_model_class2: 0.025933
    Combined effect: 0.008719
  Feature: sulphates
    via chemical_model_class0: -0.003181
    via chemical_model_class1: 0.008053
    via chemical_model_class2: -0.007340
    Combined effect: -0.002468
  Feature: residual sugar
    via physical_properties_class0: 0.007463
    via physical_properties_class1: 0.003652
    via physical_properties_class2: -0.003718
    Combined effect: 0.007396
  Feature: density
    via physical_properties_class0: -0.050738
    via physical_properties_class1: -0.024827
    via physical_properties_class2: 0.025279
    Combined effect: -0.050285
  Feature: alcohol
    via physical_properties_class0: 0.181129
    via physical_properties_class1: 0.088629
    via physical_properties_class2: -0.090244
    Combined effect: 0.179514

Verifying chain rule calculations...

===== VERIFYING CHAIN RULE FOR FEATURE: alcohol =====

Feature alcohol belongs to model physical_properties at index 2
Base model SHAP value: 0.351834

Meta-model SHAP values for this model's outputs:
  physical_properties_class0: 0.514815
  physical_properties_class1: 0.251906
  physical_properties_class2: -0.256497

Chain rule calculation:
  physical_properties_class0: 0.181129
  physical_properties_class1: 0.088629
  physical_properties_class2: -0.090244

Sum of all paths: 0.179514
Combined SHAP value: 0.179514
✓ Chain rule calculation is correct!

===== VERIFYING CHAIN RULE FOR FEATURE: volatile acidity =====

Feature volatile acidity belongs to model acidity_model at index 1
Base model SHAP value: 0.103088

Meta-model SHAP values for this model's outputs:
  acidity_model_class0: 0.263017
  acidity_model_class1: 0.287869
  acidity_model_class2: 0.223734

Chain rule calculation:
  acidity_model_class0: 0.027114
  acidity_model_class1: 0.029676
  acidity_model_class2: 0.023064

Sum of all paths: 0.079854
Combined SHAP value: 0.079854
✓ Chain rule calculation is correct!

===== VERIFYING CHAIN RULE FOR FEATURE: fixed acidity =====

Feature fixed acidity belongs to model acidity_model at index 0
Base model SHAP value: -0.079397

Meta-model SHAP values for this model's outputs:
  acidity_model_class0: 0.263017
  acidity_model_class1: 0.287869
  acidity_model_class2: 0.223734

Chain rule calculation:
  acidity_model_class0: -0.020883
  acidity_model_class1: -0.022856
  acidity_model_class2: -0.017764

Sum of all paths: -0.061502
Combined SHAP value: -0.061502
✓ Chain rule calculation is correct!

Analyzing feature influence paths...

Feature: alcohol
Total influence: 0.179514
Influence paths:
  Via physical_properties_class0: 0.181129
  Via physical_properties_class2: -0.090244
  Via physical_properties_class1: 0.088629

Feature: volatile acidity
Total influence: 0.079854
Influence paths:
  Via acidity_model_class1: 0.029676
  Via acidity_model_class0: 0.027114
  Via acidity_model_class2: 0.023064

Feature: fixed acidity
Total influence: -0.061502
Influence paths:
  Via acidity_model_class1: -0.022856
  Via acidity_model_class0: -0.020883
  Via acidity_model_class2: -0.017764

Analyzing model contributions...

Model: acidity_model
Total influence: 0.7746197501622374
Influence through meta-features:
  Via acidity_model_class0: 0.26301690588647036
  Via acidity_model_class1: 0.28786877665785143
  Via acidity_model_class2: 0.22373406761791556

Model: chemical_model
Total influence: -0.06416729296499396
Influence through meta-features:
  Via chemical_model_class0: -0.08271907892834861
  Via chemical_model_class1: 0.2093953155260533
  Via chemical_model_class2: -0.19084352956269868

Model: physical_properties
Total influence: 0.5102236171328696
Influence through meta-features:
  Via physical_properties_class0: 0.5148149915394606
  Via physical_properties_class1: 0.25190587860473895
  Via physical_properties_class2: -0.25649725301133003

Example completed successfully!</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 640x480 with 0 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="StackModelShapExplainer_files/figure-html/cell-5-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="a-new-observation" class="level2">
<h2 class="anchored" data-anchor-id="a-new-observation">A new observation</h2>
<div id="2152ab1a" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming you already have a trained StackModel called 'stack_model'</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and a DataFrame 'X_train' that was used to train the model</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new observation for a wine sample</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>new_observation <span class="op">=</span> pd.DataFrame([{</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'fixed acidity'</span>: <span class="fl">7.0</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'volatile acidity'</span>: <span class="fl">0.35</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'citric acid'</span>: <span class="fl">0.30</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'residual sugar'</span>: <span class="fl">2.0</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'chlorides'</span>: <span class="fl">0.05</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'free sulfur dioxide'</span>: <span class="fl">25.0</span>,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'total sulfur dioxide'</span>: <span class="fl">120.0</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'density'</span>: <span class="fl">0.996</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pH'</span>: <span class="fl">3.2</span>,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sulphates'</span>: <span class="fl">0.5</span>,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'alcohol'</span>: <span class="fl">10.5</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>}])</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the SHAP explainer with your trained model and training data</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>explainer <span class="op">=</span> StackModelShapExplainer(</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    stack_model<span class="op">=</span>stack_model,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    background_data<span class="op">=</span>X_test,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    n_background<span class="op">=</span><span class="dv">100</span>  <span class="co"># Use 100 background samples for efficiency</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the prediction for the new observation</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>prediction <span class="op">=</span> stack_model.predict(new_observation)[<span class="dv">0</span>]</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>probabilities <span class="op">=</span> stack_model.predict_proba(new_observation)[<span class="dv">0</span>]</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Predicted wine quality: </span><span class="sc">{</span>prediction<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Prediction probabilities: </span><span class="sc">{</span>probabilities<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Explain the prediction using the waterfall plot</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="co"># If stack_model is a binary classifier, target_class=1 would represent the positive class</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> explainer.plot_waterfall(new_observation, target_class<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="co"># You can also visualize feature importance across the entire model</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="op">=</span> explainer.plot_feature_importance(X_test, target_class<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="co"># For a deeper understanding of how features flow through the model</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>explanation <span class="op">=</span> explainer.visualize_prediction_path(new_observation, target_class<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want to inspect the raw SHAP values</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>raw_explanation <span class="op">=</span> explainer.explain_instance(new_observation, target_class<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Top 5 most influential features for this prediction:"</span>)</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature, shap_value <span class="kw">in</span> <span class="bu">sorted</span>(</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>    raw_explanation[<span class="st">'combined_shap'</span>].items(), </span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">abs</span>(x[<span class="dv">1</span>]), </span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    reverse<span class="op">=</span><span class="va">True</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>)[:<span class="dv">5</span>]:</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>shap_value<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a><span class="co"># You can also examine how each feature influences the prediction through different paths</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Influence paths for 'alcohol':"</span>)</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'alcohol'</span> <span class="kw">in</span> raw_explanation[<span class="st">'feature_influence_chain'</span>]:</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> meta_feature, influence <span class="kw">in</span> raw_explanation[<span class="st">'feature_influence_chain'</span>][<span class="st">'alcohol'</span>].items():</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  → </span><span class="sc">{</span>meta_feature<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>influence<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Predicted wine quality: 0
Prediction probabilities: [0.65455803 0.00402556 0.34141641]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="StackModelShapExplainer_files/figure-html/cell-6-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="StackModelShapExplainer_files/figure-html/cell-6-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="StackModelShapExplainer_files/figure-html/cell-6-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Top 5 most influential features for this prediction:
alcohol: 0.4244
density: 0.3190
fixed acidity: 0.2301
citric acid: -0.1939
pH: 0.0958

Influence paths for 'alcohol':
  → physical_properties_class0: 0.2445
  → physical_properties_class1: 0.1653
  → physical_properties_class2: 0.0146</code></pre>
</div>
</div>
<div id="ea38d2dd" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> store_influence_to_predicted_class(explainer, stack_model, new_observation, predicted_class):</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Store the influence of features and models on the predicted class.</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">        explainer (StackModelShapExplainer): The SHAP explainer.</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">        stack_model (StackModel): The trained stacking model.</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">        new_observation (pd.DataFrame): The feature matrix for a single instance to explain.</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">        predicted_class (int): The predicted class index for the instance.</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">        tuple: </span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">            pd.DataFrame: DataFrame containing feature influences on the predicted class.</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co">            pd.DataFrame: DataFrame containing model influences on the predicted class.</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the SHAP explanation for the given observation and predicted class</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    explanation <span class="op">=</span> explainer.explain_instance(new_observation, target_class<span class="op">=</span>predicted_class)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize lists to store feature and model influence data</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    feature_influence_data <span class="op">=</span> []</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    model_influence_data <span class="op">=</span> []</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Store feature influence ----</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature <span class="kw">in</span> new_observation.columns:  <span class="co"># Loop through all features</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        feature_influence <span class="op">=</span> explainer.get_feature_influence(explanation, feature)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        total_influence <span class="op">=</span> feature_influence[<span class="st">'combined_influence'</span>]</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        influence_paths <span class="op">=</span> feature_influence[<span class="st">'influence_paths'</span>]</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store feature influence data</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> meta_feature, influence <span class="kw">in</span> <span class="bu">sorted</span>(influence_paths.items(), key<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">abs</span>(x[<span class="dv">1</span>]), reverse<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>            feature_influence_data.append({</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Feature'</span>: feature,</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Meta Feature'</span>: meta_feature,</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Influence'</span>: influence,</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Total Influence'</span>: total_influence,</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Predicted Class'</span>: predicted_class</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Store model influence ----</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> model_name <span class="kw">in</span> stack_model.models.keys():  <span class="co"># Loop through all models</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>        model_influence <span class="op">=</span> explainer.get_model_influence(explanation, model_name)</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>        total_influence <span class="op">=</span> model_influence[<span class="st">'total_influence'</span>]</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>        meta_feature_influences <span class="op">=</span> model_influence[<span class="st">'meta_features'</span>]</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store model influence data</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> meta_feature, influence <span class="kw">in</span> meta_feature_influences.items():</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>            model_influence_data.append({</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Model'</span>: model_name,</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Meta Feature'</span>: meta_feature,</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Influence'</span>: influence,</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Total Influence'</span>: total_influence,</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Predicted Class'</span>: predicted_class</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the lists into separate DataFrames</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>    feature_influence_df <span class="op">=</span> pd.DataFrame(feature_influence_data)</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>    model_influence_df <span class="op">=</span> pd.DataFrame(model_influence_data)</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> feature_influence_df, model_influence_df</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming you already have a trained 'stack_model', 'explainer', and a new observation</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's assume the predicted class is 1 (medium quality wine in the example dataset)</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>new_observation <span class="op">=</span> pd.DataFrame([{</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">'fixed acidity'</span>: <span class="fl">7.0</span>,</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">'volatile acidity'</span>: <span class="fl">0.35</span>,</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">'citric acid'</span>: <span class="fl">0.30</span>,</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">'residual sugar'</span>: <span class="fl">2.0</span>,</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">'chlorides'</span>: <span class="fl">0.05</span>,</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">'free sulfur dioxide'</span>: <span class="fl">25.0</span>,</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">'total sulfur dioxide'</span>: <span class="fl">120.0</span>,</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">'density'</span>: <span class="fl">0.996</span>,</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pH'</span>: <span class="fl">3.2</span>,</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sulphates'</span>: <span class="fl">0.5</span>,</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">'alcohol'</span>: <span class="fl">10.5</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>}])</span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>predicted_class <span class="op">=</span> <span class="dv">1</span>  <span class="co"># For example, class 1 (e.g., medium quality in the wine dataset)</span></span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the function to store influences for the predicted class</span></span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>feature_influence_df, model_influence_df <span class="op">=</span> store_influence_to_predicted_class(explainer, stack_model, new_observation, predicted_class)</span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="61f64577" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>file_name <span class="op">=</span> <span class="st">'influence_df.xlsx'</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.ExcelWriter(file_name, engine<span class="op">=</span><span class="st">'xlsxwriter'</span>) <span class="im">as</span> writer:</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save each DataFrame to a different sheet</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    feature_influence_df.to_excel(writer, sheet_name<span class="op">=</span><span class="st">'Feature Influence'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    model_influence_df.to_excel(writer, sheet_name<span class="op">=</span><span class="st">'Model Influence'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6e8bad53" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>predicted_class <span class="op">=</span> <span class="dv">0</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>feature_influence_df, model_influence_df <span class="op">=</span> store_influence_to_predicted_class(explainer, stack_model, new_observation, predicted_class)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>file_name <span class="op">=</span> <span class="st">'influence_df0.xlsx'</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.ExcelWriter(file_name, engine<span class="op">=</span><span class="st">'xlsxwriter'</span>) <span class="im">as</span> writer:</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save each DataFrame to a different sheet</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    feature_influence_df.to_excel(writer, sheet_name<span class="op">=</span><span class="st">'Feature Influence'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    model_influence_df.to_excel(writer, sheet_name<span class="op">=</span><span class="st">'Model Influence'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="35abdadb" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>explanation <span class="op">=</span> explainer.explain_instance(new_observation, target_class<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>explanation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>{'combined_shap': {'fixed acidity': 0.23006162160601437,
  'volatile acidity': -0.006290676600541171,
  'citric acid': -0.1938829505432772,
  'pH': 0.0957712563895823,
  'chlorides': -0.004115580133319979,
  'free sulfur dioxide': 0.0035060000889678335,
  'total sulfur dioxide': -0.0008107644553777969,
  'sulphates': 0.002053618847751592,
  'residual sugar': -0.07281704415414081,
  'density': 0.31899564561470933,
  'alcohol': 0.4244219215434195},
 'feature_influence_chain': {'fixed acidity': {'acidity_model_class0': 0.1834103026442602,
   'acidity_model_class1': 0.045779502543218616,
   'acidity_model_class2': 0.0008718164185355561},
  'volatile acidity': {'acidity_model_class0': -0.005015068967558123,
   'acidity_model_class1': -0.0012517691713319287,
   'acidity_model_class2': -2.383846165111903e-05},
  'citric acid': {'acidity_model_class0': -0.15456785181494598,
   'acidity_model_class1': -0.03858038105409343,
   'acidity_model_class2': -0.000734717674237794},
  'pH': {'acidity_model_class0': 0.07635100107707458,
   'acidity_model_class1': 0.019057331009178228,
   'acidity_model_class2': 0.0003629243033294928},
  'chlorides': {'chemical_model_class0': -0.0040471153273282275,
   'chemical_model_class1': -0.007165484100469425,
   'chemical_model_class2': 0.007097019294477673},
  'free sulfur dioxide': {'chemical_model_class0': 0.0034476759625694953,
   'chemical_model_class1': 0.006104166868323785,
   'chemical_model_class2': -0.006045842741925446},
  'total sulfur dioxide': {'chemical_model_class0': -0.000797276968961715,
   'chemical_model_class1': -0.0014115919569154152,
   'chemical_model_class2': 0.0013981044704993333},
  'sulphates': {'chemical_model_class0': 0.002019455835141534,
   'chemical_model_class1': 0.0035754796955242024,
   'chemical_model_class2': -0.0035413166829141437},
  'residual sugar': {'physical_properties_class0': -0.041955866451511795,
   'physical_properties_class1': -0.028352813796893587,
   'physical_properties_class2': -0.002508363905735435},
  'density': {'physical_properties_class0': 0.18379953294579657,
   'physical_properties_class1': 0.12420751552326484,
   'physical_properties_class2': 0.010988597145647901},
  'alcohol': {'physical_properties_class0': 0.24454425013016837,
   'physical_properties_class1': 0.16525740439789674,
   'physical_properties_class2': 0.014620267015354403}},
 'meta_model_shap': array([[-1.0238338 , -0.25555054, -0.00486666, -0.02725937, -0.04826316,
          0.04780201, -0.92701782, -0.62645742, -0.05542248]]),
 'base_model_shap': {'acidity_model': {'shap_values': array([[-0.1791407 ,  0.00489832,  0.15096967, -0.07457363]]),
   'feature_names': ['fixed acidity',
    'volatile acidity',
    'citric acid',
    'pH']},
  'chemical_model': {'shap_values': array([[ 0.14846695, -0.12647674,  0.02924781, -0.074083  ]]),
   'feature_names': ['chlorides',
    'free sulfur dioxide',
    'total sulfur dioxide',
    'sulphates']},
  'physical_properties': {'shap_values': array([[ 0.04525896, -0.19826969, -0.26379671]]),
   'feature_names': ['residual sugar', 'density', 'alcohol']}},
 'meta_features': array([[0.39118684, 0.24643168, 0.36238148, 0.34323587, 0.3007726 ,
         0.35599153, 0.35208745, 0.18631852, 0.46159403]]),
 'expected_value': {'acidity_model': array([-1.31959511, -1.33981237, -1.12389672]),
  'chemical_model': array([-1.0379243 , -1.11911687, -1.27916369]),
  'physical_properties': array([-1.35701102, -1.35865684, -1.22170098]),
  'meta_model': array([-2.18849207, -1.81391848, -1.36151378])}}</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/nguyenngocbinh\.github\.io\/papers");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../machine-learning/deep_dive_stacking_model_multi_class.html" class="pagination-link" aria-label="Deep Dive into Stacking Model for Multi-Class Classification">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Deep Dive into Stacking Model for Multi-Class Classification</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../statistic/Index.html" class="pagination-link" aria-label="Statistic">
        <span class="nav-page-text">Statistic</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© CC-By NguyenNgocBinh, 2023</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.dev/nguyenngocbinh/papers/blob/main/machine-learning/StackModelShapExplainer.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/nguyenngocbinh/papers/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This page is built with ❤️ and <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>